{"version":3,"sources":["../../../../app/dashboard/actions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { createAdminClient } from '@/lib/supabase/server-admin';\r\nimport { Booking } from '@/types/booking';\r\nimport { Profile, ProfileUpdateInput } from '@/types/profile';\r\nimport { Location, LocationCreateInput, LocationUpdateInput } from '@/types/location';\r\n\r\nexport async function getAuthenticatedUser(): Promise<{\r\n  success: boolean;\r\n  email?: string;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n    const { data: { user }, error } = await supabase.auth.getUser();\r\n\r\n    if (error || !user) {\r\n      return { success: false, error: 'Not authenticated' };\r\n    }\r\n\r\n    return { success: true, email: user.email || undefined };\r\n  } catch (error) {\r\n    console.error('Error in getAuthenticatedUser:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to get user',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getCustomerBookings(\r\n  email: string,\r\n  phone?: string,\r\n  filter?: 'all' | 'upcoming' | 'completed' | 'cancelled'\r\n): Promise<{\r\n  success: boolean;\r\n  bookings?: Booking[];\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    let query = supabase\r\n      .from('bookings')\r\n      .select('*')\r\n      .order('service_date', { ascending: false })\r\n      .order('created_at', { ascending: false });\r\n\r\n    // Build query for email/phone lookup\r\n    if (email && phone) {\r\n      query = query.or(`customer_email.eq.${email},customer_phone.eq.${phone}`);\r\n    } else if (email) {\r\n      query = query.eq('customer_email', email);\r\n    } else if (phone) {\r\n      query = query.eq('customer_phone', phone);\r\n    } else {\r\n      return { success: false, error: 'Email or phone is required' };\r\n    }\r\n\r\n    // Apply status filter\r\n    if (filter && filter !== 'all') {\r\n      if (filter === 'upcoming') {\r\n        query = query.in('status', ['pending', 'confirmed']);\r\n      } else {\r\n        query = query.eq('status', filter);\r\n      }\r\n    }\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n      console.error('Error fetching bookings:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n\r\n    return { success: true, bookings: data || [] };\r\n  } catch (error) {\r\n    console.error('Error in getCustomerBookings:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to fetch bookings',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getCustomerBookingStats(\r\n  email: string,\r\n  phone?: string\r\n): Promise<{\r\n  success: boolean;\r\n  stats?: {\r\n    total: number;\r\n    upcoming: number;\r\n    completed: number;\r\n    cancelled: number;\r\n    totalSpent: number;\r\n  };\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    let query = supabase\r\n      .from('bookings')\r\n      .select('status, total_amount, payment_status');\r\n\r\n    // Build query for email/phone lookup\r\n    if (email && phone) {\r\n      query = query.or(`customer_email.eq.${email},customer_phone.eq.${phone}`);\r\n    } else if (email) {\r\n      query = query.eq('customer_email', email);\r\n    } else if (phone) {\r\n      query = query.eq('customer_phone', phone);\r\n    } else {\r\n      return { success: false, error: 'Email or phone is required' };\r\n    }\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n      return { success: false, error: error.message };\r\n    }\r\n\r\n    const stats = {\r\n      total: data?.length || 0,\r\n      upcoming: data?.filter((b) => b.status === 'pending' || b.status === 'confirmed').length || 0,\r\n      completed: data?.filter((b) => b.status === 'completed').length || 0,\r\n      cancelled: data?.filter((b) => b.status === 'cancelled').length || 0,\r\n      totalSpent: data\r\n        ?.filter((b) => b.payment_status === 'paid')\r\n        .reduce((sum, b) => sum + (b.total_amount || 0), 0) || 0,\r\n    };\r\n\r\n    return { success: true, stats };\r\n  } catch (error) {\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to fetch stats',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getBookingById(id: string): Promise<{\r\n  success: boolean;\r\n  booking?: Booking;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    const { data, error } = await supabase\r\n      .from('bookings')\r\n      .select('*')\r\n      .eq('id', id)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('Error fetching booking:', error);\r\n      return { success: false, error: 'Booking not found' };\r\n    }\r\n\r\n    return { success: true, booking: data };\r\n  } catch (error) {\r\n    console.error('Unexpected error fetching booking:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'An unexpected error occurred',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getCustomerProfile(\r\n  email: string,\r\n  phone?: string\r\n): Promise<{\r\n  success: boolean;\r\n  profile?: Profile;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // First, try to get profile from profiles table\r\n    let query = supabase.from('profiles').select('*');\r\n\r\n    if (email) {\r\n      query = query.eq('email', email);\r\n    } else if (phone) {\r\n      query = query.eq('phone', phone);\r\n    } else {\r\n      return { success: false, error: 'Email or phone is required' };\r\n    }\r\n\r\n    const { data: profileData, error: profileError } = await query.maybeSingle();\r\n\r\n    // If profile exists, return it\r\n    if (profileData && !profileError) {\r\n      return { success: true, profile: profileData };\r\n    }\r\n\r\n    // If no profile exists, derive from most recent booking\r\n    let bookingQuery = supabase\r\n      .from('bookings')\r\n      .select('customer_first_name, customer_last_name, customer_email, customer_phone')\r\n      .order('created_at', { ascending: false })\r\n      .limit(1);\r\n\r\n    if (email && phone) {\r\n      bookingQuery = bookingQuery.or(`customer_email.eq.${email},customer_phone.eq.${phone}`);\r\n    } else if (email) {\r\n      bookingQuery = bookingQuery.eq('customer_email', email);\r\n    } else if (phone) {\r\n      bookingQuery = bookingQuery.eq('customer_phone', phone);\r\n    }\r\n\r\n    const { data: bookingData, error: bookingError } = await bookingQuery.maybeSingle();\r\n\r\n    if (bookingError || !bookingData) {\r\n      return {\r\n        success: false,\r\n        error: 'No profile or booking found. Please create a booking first.',\r\n      };\r\n    }\r\n\r\n    // Create a profile object from booking data\r\n    const derivedProfile: Profile = {\r\n      id: '', // Will be generated when saved\r\n      email: bookingData.customer_email,\r\n      phone: bookingData.customer_phone || null,\r\n      first_name: bookingData.customer_first_name,\r\n      last_name: bookingData.customer_last_name,\r\n      referral_code: null,\r\n      avatar_url: null,\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n    };\r\n\r\n    return { success: true, profile: derivedProfile };\r\n  } catch (error) {\r\n    console.error('Error in getCustomerProfile:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to fetch profile',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function uploadProfilePicture(\r\n  email: string,\r\n  fileData: string, // base64 encoded string\r\n  fileName: string,\r\n  fileType: string\r\n): Promise<{\r\n  success: boolean;\r\n  url?: string;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    // Use admin client for storage uploads if service role key is available\r\n    // If not available, fall back to authenticated client for storage (storage policies may still work)\r\n    let supabase;\r\n    try {\r\n      supabase = createAdminClient();\r\n      console.log('‚úÖ Using admin client for storage upload');\r\n    } catch (error) {\r\n      console.warn('‚ö†Ô∏è Service role key not set, using authenticated client for storage upload');\r\n      supabase = await createClient();\r\n    }\r\n\r\n    // Validate file type\r\n    const validImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];\r\n    if (!validImageTypes.includes(fileType)) {\r\n      return { success: false, error: 'Invalid file type. Please upload a JPEG, PNG, or WebP image.' };\r\n    }\r\n\r\n    // Decode base64 data\r\n    const base64Data = fileData.replace(/^data:image\\/\\w+;base64,/, '');\r\n    const buffer = Buffer.from(base64Data, 'base64');\r\n\r\n    // Validate file size (max 5MB)\r\n    const maxSize = 5 * 1024 * 1024; // 5MB in bytes\r\n    if (buffer.length > maxSize) {\r\n      return { success: false, error: 'File size too large. Please upload an image smaller than 5MB.' };\r\n    }\r\n\r\n    // Generate unique filename using email and timestamp\r\n    const fileExt = fileName.split('.').pop() || 'jpg';\r\n    const sanitizedEmail = email.replace(/[^a-zA-Z0-9]/g, '_');\r\n    const uniqueFileName = `${sanitizedEmail}_${Date.now()}.${fileExt}`;\r\n    const filePath = `avatars/${uniqueFileName}`;\r\n\r\n    // Upload to Supabase Storage\r\n    const { data: uploadData, error: uploadError } = await supabase.storage\r\n      .from('profile-pictures')\r\n      .upload(filePath, buffer, {\r\n        contentType: fileType,\r\n        upsert: false,\r\n      });\r\n\r\n      if (uploadError) {\r\n        console.error('‚ùå Storage upload error:', uploadError);\r\n        console.error('Upload error details:', {\r\n          message: uploadError.message,\r\n          statusCode: uploadError.statusCode,\r\n          error: uploadError.error,\r\n        });\r\n        \r\n        // Check for storage RLS errors\r\n        if (uploadError.message?.includes('row-level security') || \r\n            uploadError.message?.includes('RLS') ||\r\n            uploadError.message?.includes('policy')) {\r\n          return { \r\n            success: false, \r\n            error: 'Storage bucket RLS policy error. Please check your \"profile-pictures\" bucket policies in Supabase Storage. The bucket needs policies that allow authenticated users to upload files.',\r\n          };\r\n        }\r\n        \r\n        // If bucket doesn't exist, return helpful error\r\n        if (uploadError.message.includes('not found') || uploadError.message.includes('Bucket')) {\r\n          return { \r\n            success: false, \r\n            error: 'Storage bucket not configured. Please create a \"profile-pictures\" bucket in Supabase Storage.',\r\n          };\r\n        }\r\n        return { \r\n          success: false, \r\n          error: uploadError.message || 'Failed to upload file',\r\n        };\r\n      }\r\n\r\n    // Get public URL\r\n    const { data: urlData } = supabase.storage\r\n      .from('profile-pictures')\r\n      .getPublicUrl(filePath);\r\n\r\n    return { success: true, url: urlData.publicUrl };\r\n  } catch (error) {\r\n    console.error('Error in uploadProfilePicture:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to upload profile picture',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function deleteProfilePicture(email: string, avatarUrl: string): Promise<{\r\n  success: boolean;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Extract file path from URL\r\n    // URL format: https://[project].supabase.co/storage/v1/object/public/profile-pictures/avatars/filename.jpg\r\n    const urlPattern = /\\/profile-pictures\\/(.+)$/;\r\n    const match = avatarUrl.match(urlPattern);\r\n    \r\n    if (!match || !match[1]) {\r\n      // If URL doesn't match expected pattern, try alternative parsing\r\n      const urlParts = avatarUrl.split('/avatars/');\r\n      if (urlParts.length < 2) {\r\n        // If we can't parse the URL, just return success (the file might already be deleted)\r\n        console.warn('Could not parse avatar URL for deletion:', avatarUrl);\r\n        return { success: true };\r\n      }\r\n      const filePath = `avatars/${urlParts[1].split('?')[0]}`;\r\n      const { error: deleteError } = await supabase.storage\r\n        .from('profile-pictures')\r\n        .remove([filePath]);\r\n\r\n      if (deleteError && !deleteError.message.includes('not found')) {\r\n        console.error('Error deleting file:', deleteError);\r\n        return { success: false, error: deleteError.message };\r\n      }\r\n      return { success: true };\r\n    }\r\n\r\n    const filePath = match[1].split('?')[0]; // Remove query parameters if any\r\n\r\n    // Delete from storage\r\n    const { error: deleteError } = await supabase.storage\r\n      .from('profile-pictures')\r\n      .remove([filePath]);\r\n\r\n    if (deleteError) {\r\n      console.error('Error deleting file:', deleteError);\r\n      // Don't fail if file doesn't exist\r\n      if (deleteError.message.includes('not found') || deleteError.message.includes('No such file')) {\r\n        return { success: true };\r\n      }\r\n      return { success: false, error: deleteError.message };\r\n    }\r\n\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('Error in deleteProfilePicture:', error);\r\n    // Don't fail completely - the URL in database will be removed anyway\r\n    return { success: true };\r\n  }\r\n}\r\n\r\nexport async function updateCustomerProfile(\r\n  email: string,\r\n  data: ProfileUpdateInput\r\n): Promise<{\r\n  success: boolean;\r\n  profile?: Profile;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    // First, verify the authenticated user matches the email\r\n    const authSupabase = await createClient();\r\n    const { data: { user }, error: authError } = await authSupabase.auth.getUser();\r\n    \r\n    if (authError || !user) {\r\n      return { success: false, error: 'Not authenticated' };\r\n    }\r\n\r\n    // Verify that the email parameter matches the authenticated user's email\r\n    // This ensures users can only update their own profile\r\n    if (user.email?.toLowerCase() !== email.toLowerCase() && user.email?.toLowerCase() !== data.email?.toLowerCase()) {\r\n      return { success: false, error: 'Unauthorized: You can only update your own profile' };\r\n    }\r\n\r\n    // ALWAYS use admin client for profile operations - it bypasses RLS completely\r\n    // This is REQUIRED - we cannot use authenticated client as it may still check RLS policies\r\n    let supabase;\r\n    try {\r\n      supabase = createAdminClient();\r\n      console.log('‚úÖ Using admin client for profile operations');\r\n    } catch (error) {\r\n      // Do NOT fall back to authenticated client - it will cause RLS errors\r\n      console.error('‚ùå Failed to create admin client:', error);\r\n      return {\r\n        success: false,\r\n        error: 'SUPABASE_SERVICE_ROLE_KEY is not set. This is REQUIRED for profile operations. Please add it to your .env.local file. Get it from: Supabase Dashboard ‚Üí Settings ‚Üí API ‚Üí service_role key (secret)',\r\n      };\r\n    }\r\n    \r\n    // Verify we have a valid client (should never happen due to error above, but double-check)\r\n    if (!supabase) {\r\n      return { \r\n        success: false, \r\n        error: 'Failed to initialize database client. Please check your SUPABASE_SERVICE_ROLE_KEY in .env.local' \r\n      };\r\n    }\r\n\r\n    // Validate input\r\n    if (!data.first_name?.trim()) {\r\n      return { success: false, error: 'First name is required' };\r\n    }\r\n    if (!data.last_name?.trim()) {\r\n      return { success: false, error: 'Last name is required' };\r\n    }\r\n    if (!data.email?.trim()) {\r\n      return { success: false, error: 'Email is required' };\r\n    }\r\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(data.email)) {\r\n      return { success: false, error: 'Invalid email format' };\r\n    }\r\n\r\n    // Verify the new email (if changed) still matches the authenticated user\r\n    if (data.email.toLowerCase() !== user.email?.toLowerCase()) {\r\n      // Allow email change only if it's the same user (case insensitive check above passed)\r\n      // But we should verify it's a valid change (user updating their own email)\r\n      if (data.email.toLowerCase() !== email.toLowerCase()) {\r\n        // Email is being changed - verify it's still the same user\r\n        // For now, we'll allow it but in production you might want to require email verification\r\n      }\r\n    }\r\n\r\n    // Check if profile exists\r\n    console.log('üîç Checking if profile exists for email:', email);\r\n    console.log('üîç Using client type:', process.env.SUPABASE_SERVICE_ROLE_KEY ? 'ADMIN (service role)' : 'AUTHENTICATED (anon key)');\r\n    \r\n    const { data: existingProfile, error: selectError } = await supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .eq('email', email)\r\n      .maybeSingle();\r\n    \r\n    if (selectError) {\r\n      console.error('‚ùå Error selecting profile:', selectError);\r\n      return { success: false, error: `Failed to check profile: ${selectError.message}` };\r\n    }\r\n    \r\n    console.log('‚úÖ Profile check result:', existingProfile ? 'Profile exists (will UPDATE)' : 'Profile does not exist (will INSERT)');\r\n\r\n    // If avatar_url is being removed, delete the old file\r\n    if (existingProfile?.avatar_url && data.avatar_url === null) {\r\n      await deleteProfilePicture(email, existingProfile.avatar_url);\r\n    }\r\n\r\n    let result;\r\n    if (existingProfile) {\r\n      // Update existing profile\r\n      // If email changed, we need to handle it carefully\r\n      if (data.email !== email) {\r\n        // Check if new email already exists\r\n        const { data: emailCheck } = await supabase\r\n          .from('profiles')\r\n          .select('id')\r\n          .eq('email', data.email)\r\n          .maybeSingle();\r\n\r\n        if (emailCheck) {\r\n          return { success: false, error: 'Email already exists' };\r\n        }\r\n      }\r\n\r\n      const updateData: any = {\r\n          first_name: data.first_name.trim(),\r\n          last_name: data.last_name.trim(),\r\n          email: data.email.trim(),\r\n          phone: data.phone?.trim() || null,\r\n          updated_at: new Date().toISOString(),\r\n      };\r\n\r\n      // Handle avatar_url: undefined means don't change, null means remove, string means set\r\n      if (data.avatar_url !== undefined) {\r\n        updateData.avatar_url = data.avatar_url === null ? null : data.avatar_url;\r\n      }\r\n\r\n      console.log('üìù Attempting to UPDATE profile with data:', updateData);\r\n      console.log('üìù Update WHERE email =', email);\r\n      \r\n      const { data: updatedProfile, error: updateError } = await supabase\r\n        .from('profiles')\r\n        .update(updateData)\r\n        .eq('email', email)\r\n        .select()\r\n        .single();\r\n\r\n      if (updateError) {\r\n        console.error('‚ùå Error updating profile:', updateError);\r\n        console.error('‚ùå Update error details:', {\r\n          code: updateError.code,\r\n          message: updateError.message,\r\n          details: updateError.details,\r\n          hint: updateError.hint,\r\n          statusCode: (updateError as any).statusCode,\r\n          status: (updateError as any).status,\r\n          serviceRoleKeySet: !!process.env.SUPABASE_SERVICE_ROLE_KEY,\r\n        });\r\n        \r\n        // Check for RLS errors specifically\r\n        if (updateError.message?.includes('row-level security') || \r\n            updateError.code === '42501' ||\r\n            updateError.message?.includes('RLS')) {\r\n          return { \r\n            success: false, \r\n            error: 'Row Level Security error. Please ensure: 1) RLS is disabled on profiles table, 2) SUPABASE_SERVICE_ROLE_KEY is set in .env.local',\r\n          };\r\n        }\r\n        \r\n        return { \r\n          success: false, \r\n          error: updateError.message || 'Failed to update profile',\r\n        };\r\n      }\r\n\r\n      result = updatedProfile;\r\n    } else {\r\n      // Create new profile\r\n      const insertData: any = {\r\n          email: data.email.trim(),\r\n          phone: data.phone?.trim() || null,\r\n          first_name: data.first_name.trim(),\r\n          last_name: data.last_name.trim(),\r\n      };\r\n\r\n      // Only set avatar_url if it's provided\r\n      if (data.avatar_url) {\r\n        insertData.avatar_url = data.avatar_url;\r\n      }\r\n\r\n      const { data: newProfile, error: insertError } = await supabase\r\n        .from('profiles')\r\n        .insert(insertData)\r\n        .select()\r\n        .single();\r\n\r\n      if (insertError) {\r\n        console.error('Error creating profile:', insertError);\r\n        console.error('‚ùå Insert error details:', {\r\n          code: insertError.code,\r\n          message: insertError.message,\r\n          details: insertError.details,\r\n          hint: insertError.hint,\r\n          serviceRoleKeySet: !!process.env.SUPABASE_SERVICE_ROLE_KEY,\r\n        });\r\n        // Check if it's a unique constraint violation\r\n        if (insertError.code === '23505') {\r\n          return { success: false, error: 'Email already exists' };\r\n        }\r\n        // Check if it's an RLS error\r\n        if (insertError.message?.includes('row-level security') || \r\n            insertError.code === '42501' ||\r\n            insertError.message?.includes('RLS')) {\r\n          return { \r\n            success: false, \r\n            error: 'Row Level Security error. Please ensure: 1) RLS is disabled on profiles table, 2) SUPABASE_SERVICE_ROLE_KEY is set in .env.local',\r\n          };\r\n        }\r\n        return { \r\n          success: false, \r\n          error: insertError.message || 'Failed to create profile',\r\n        };\r\n      }\r\n\r\n      result = newProfile;\r\n    }\r\n\r\n    return { success: true, profile: result };\r\n  } catch (error) {\r\n    console.error('Error in updateCustomerProfile:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to update profile',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getCustomerLocations(\r\n  email: string,\r\n  phone?: string\r\n): Promise<{\r\n  success: boolean;\r\n  locations?: Location[];\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    let query = supabase\r\n      .from('locations')\r\n      .select('*')\r\n      .order('is_default', { ascending: false })\r\n      .order('created_at', { ascending: false });\r\n\r\n    // Build query for email/phone lookup\r\n    if (email && phone) {\r\n      query = query.or(`customer_email.eq.${email},customer_phone.eq.${phone}`);\r\n    } else if (email) {\r\n      query = query.eq('customer_email', email);\r\n    } else if (phone) {\r\n      query = query.eq('customer_phone', phone);\r\n    } else {\r\n      return { success: false, error: 'Email or phone is required' };\r\n    }\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n      console.error('Error fetching locations:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n\r\n    return { success: true, locations: data || [] };\r\n  } catch (error) {\r\n    console.error('Error in getCustomerLocations:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to fetch locations',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function createLocation(\r\n  email: string,\r\n  phone: string | undefined,\r\n  locationData: LocationCreateInput\r\n): Promise<{\r\n  success: boolean;\r\n  location?: Location;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Validate input\r\n    if (!locationData.nickname?.trim()) {\r\n      return { success: false, error: 'Nickname is required' };\r\n    }\r\n    if (!locationData.address?.trim()) {\r\n      return { success: false, error: 'Address is required' };\r\n    }\r\n    if (!locationData.suburb?.trim()) {\r\n      return { success: false, error: 'Suburb is required' };\r\n    }\r\n    if (!locationData.city?.trim()) {\r\n      return { success: false, error: 'City is required' };\r\n    }\r\n\r\n    // If setting as default, unset all other defaults for this customer\r\n    if (locationData.is_default) {\r\n      let updateQuery = supabase\r\n        .from('locations')\r\n        .update({ is_default: false });\r\n\r\n      if (email && phone) {\r\n        updateQuery = updateQuery.or(`customer_email.eq.${email},customer_phone.eq.${phone}`);\r\n      } else if (email) {\r\n        updateQuery = updateQuery.eq('customer_email', email);\r\n      } else if (phone) {\r\n        updateQuery = updateQuery.eq('customer_phone', phone);\r\n      }\r\n\r\n      await updateQuery;\r\n    }\r\n\r\n    const { data: newLocation, error: insertError } = await supabase\r\n      .from('locations')\r\n      .insert({\r\n        customer_email: email,\r\n        customer_phone: phone || null,\r\n        nickname: locationData.nickname.trim(),\r\n        address: locationData.address.trim(),\r\n        apt_unit: locationData.apt_unit?.trim() || null,\r\n        suburb: locationData.suburb.trim(),\r\n        city: locationData.city.trim(),\r\n        postal_code: locationData.postal_code?.trim() || null,\r\n        is_default: locationData.is_default || false,\r\n      })\r\n      .select()\r\n      .single();\r\n\r\n    if (insertError) {\r\n      console.error('Error creating location:', insertError);\r\n      return { success: false, error: insertError.message };\r\n    }\r\n\r\n    return { success: true, location: newLocation };\r\n  } catch (error) {\r\n    console.error('Error in createLocation:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to create location',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function updateLocation(\r\n  locationId: string,\r\n  locationData: LocationUpdateInput\r\n): Promise<{\r\n  success: boolean;\r\n  location?: Location;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Validate input if provided\r\n    if (locationData.nickname !== undefined && !locationData.nickname.trim()) {\r\n      return { success: false, error: 'Nickname is required' };\r\n    }\r\n    if (locationData.address !== undefined && !locationData.address.trim()) {\r\n      return { success: false, error: 'Address is required' };\r\n    }\r\n    if (locationData.suburb !== undefined && !locationData.suburb.trim()) {\r\n      return { success: false, error: 'Suburb is required' };\r\n    }\r\n    if (locationData.city !== undefined && !locationData.city.trim()) {\r\n      return { success: false, error: 'City is required' };\r\n    }\r\n\r\n    // Get current location to check customer email\r\n    const { data: currentLocation, error: fetchError } = await supabase\r\n      .from('locations')\r\n      .select('customer_email, customer_phone')\r\n      .eq('id', locationId)\r\n      .single();\r\n\r\n    if (fetchError || !currentLocation) {\r\n      return { success: false, error: 'Location not found' };\r\n    }\r\n\r\n    // If setting as default, unset all other defaults for this customer\r\n    if (locationData.is_default) {\r\n      let updateQuery = supabase\r\n        .from('locations')\r\n        .update({ is_default: false });\r\n\r\n      if (currentLocation.customer_email && currentLocation.customer_phone) {\r\n        updateQuery = updateQuery.or(`customer_email.eq.${currentLocation.customer_email},customer_phone.eq.${currentLocation.customer_phone}`);\r\n      } else if (currentLocation.customer_email) {\r\n        updateQuery = updateQuery.eq('customer_email', currentLocation.customer_email);\r\n      } else if (currentLocation.customer_phone) {\r\n        updateQuery = updateQuery.eq('customer_phone', currentLocation.customer_phone);\r\n      }\r\n\r\n      // Don't unset the current location\r\n      updateQuery = updateQuery.neq('id', locationId);\r\n\r\n      await updateQuery;\r\n    }\r\n\r\n    // Build update object with only provided fields\r\n    const updateData: any = {\r\n      updated_at: new Date().toISOString(),\r\n    };\r\n\r\n    if (locationData.nickname !== undefined) {\r\n      updateData.nickname = locationData.nickname.trim();\r\n    }\r\n    if (locationData.address !== undefined) {\r\n      updateData.address = locationData.address.trim();\r\n    }\r\n    if (locationData.apt_unit !== undefined) {\r\n      updateData.apt_unit = locationData.apt_unit?.trim() || null;\r\n    }\r\n    if (locationData.suburb !== undefined) {\r\n      updateData.suburb = locationData.suburb.trim();\r\n    }\r\n    if (locationData.city !== undefined) {\r\n      updateData.city = locationData.city.trim();\r\n    }\r\n    if (locationData.postal_code !== undefined) {\r\n      updateData.postal_code = locationData.postal_code?.trim() || null;\r\n    }\r\n    if (locationData.is_default !== undefined) {\r\n      updateData.is_default = locationData.is_default;\r\n    }\r\n\r\n    const { data: updatedLocation, error: updateError } = await supabase\r\n      .from('locations')\r\n      .update(updateData)\r\n      .eq('id', locationId)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      console.error('Error updating location:', updateError);\r\n      return { success: false, error: updateError.message };\r\n    }\r\n\r\n    return { success: true, location: updatedLocation };\r\n  } catch (error) {\r\n    console.error('Error in updateLocation:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to update location',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function deleteLocation(locationId: string): Promise<{\r\n  success: boolean;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    const { error } = await supabase\r\n      .from('locations')\r\n      .delete()\r\n      .eq('id', locationId);\r\n\r\n    if (error) {\r\n      console.error('Error deleting location:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error('Error in deleteLocation:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to delete location',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function setDefaultLocation(\r\n  locationId: string,\r\n  email: string,\r\n  phone?: string\r\n): Promise<{\r\n  success: boolean;\r\n  location?: Location;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Get current location to verify ownership\r\n    const { data: currentLocation, error: fetchError } = await supabase\r\n      .from('locations')\r\n      .select('customer_email, customer_phone')\r\n      .eq('id', locationId)\r\n      .single();\r\n\r\n    if (fetchError || !currentLocation) {\r\n      return { success: false, error: 'Location not found' };\r\n    }\r\n\r\n    // Verify ownership\r\n    const isOwner = \r\n      currentLocation.customer_email === email ||\r\n      (phone && currentLocation.customer_phone === phone);\r\n\r\n    if (!isOwner) {\r\n      return { success: false, error: 'Unauthorized' };\r\n    }\r\n\r\n    // Unset all other defaults for this customer\r\n    let updateQuery = supabase\r\n      .from('locations')\r\n      .update({ is_default: false });\r\n\r\n    if (email && phone) {\r\n      updateQuery = updateQuery.or(`customer_email.eq.${email},customer_phone.eq.${phone}`);\r\n    } else if (email) {\r\n      updateQuery = updateQuery.eq('customer_email', email);\r\n    } else if (phone) {\r\n      updateQuery = updateQuery.eq('customer_phone', phone);\r\n    }\r\n\r\n    // Don't unset the current location\r\n    updateQuery = updateQuery.neq('id', locationId);\r\n\r\n    await updateQuery;\r\n\r\n    // Set this location as default\r\n    const { data: updatedLocation, error: updateError } = await supabase\r\n      .from('locations')\r\n      .update({ is_default: true })\r\n      .eq('id', locationId)\r\n      .select()\r\n      .single();\r\n\r\n    if (updateError) {\r\n      console.error('Error setting default location:', updateError);\r\n      return { success: false, error: updateError.message };\r\n    }\r\n\r\n    return { success: true, location: updatedLocation };\r\n  } catch (error) {\r\n    console.error('Error in setDefaultLocation:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to set default location',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getOrCreateReferralCode(\r\n  email: string\r\n): Promise<{\r\n  success: boolean;\r\n  referralCode?: string;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Check if profile exists and has a referral code\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from('profiles')\r\n      .select('referral_code')\r\n      .eq('email', email)\r\n      .maybeSingle();\r\n\r\n    if (profileError && profileError.code !== 'PGRST116') {\r\n      console.error('Error fetching profile:', profileError);\r\n      return { success: false, error: profileError.message };\r\n    }\r\n\r\n    // If profile exists and has a referral code, return it\r\n    if (profile?.referral_code) {\r\n      return { success: true, referralCode: profile.referral_code };\r\n    }\r\n\r\n    // Generate a new referral code\r\n    // Try using the database function first, but fallback to client-side generation\r\n    let generatedCode: string | null = null;\r\n    \r\n    try {\r\n      const { data: dbCode, error: codeError } = await supabase\r\n        .rpc('generate_referral_code');\r\n      \r\n      if (!codeError && dbCode) {\r\n        generatedCode = dbCode;\r\n      }\r\n    } catch (rpcError) {\r\n      // RPC function might not exist yet, that's okay\r\n      console.log('RPC function not available, using fallback');\r\n    }\r\n\r\n    if (!generatedCode) {\r\n      // Fallback: generate code client-side style\r\n      const fallbackCode = Math.random().toString(36).substring(2, 8).toUpperCase();\r\n      \r\n      // Check if fallback code exists, retry if it does\r\n      let finalCode = fallbackCode;\r\n      let attempts = 0;\r\n      const maxAttempts = 5;\r\n\r\n      while (attempts < maxAttempts) {\r\n        const { data: existing } = await supabase\r\n          .from('profiles')\r\n          .select('id')\r\n          .eq('referral_code', finalCode)\r\n          .maybeSingle();\r\n\r\n        if (!existing) {\r\n          break; // Code is unique\r\n        }\r\n\r\n        // Generate a new code\r\n        finalCode = Math.random().toString(36).substring(2, 8).toUpperCase();\r\n        attempts++;\r\n      }\r\n\r\n      // Update or insert profile with referral code\r\n      // First, try to update existing profile\r\n      const { data: existingProfile } = await supabase\r\n        .from('profiles')\r\n        .select('id, first_name, last_name')\r\n        .eq('email', email)\r\n        .maybeSingle();\r\n\r\n      let updatedProfile;\r\n      if (existingProfile) {\r\n        // Update existing profile\r\n        const { data: updated, error: updateError } = await supabase\r\n          .from('profiles')\r\n          .update({\r\n            referral_code: finalCode,\r\n            updated_at: new Date().toISOString(),\r\n          })\r\n          .eq('email', email)\r\n          .select('referral_code')\r\n          .single();\r\n\r\n        if (updateError) {\r\n          console.error('Error updating referral code:', updateError);\r\n          return { success: false, error: updateError.message };\r\n        }\r\n        updatedProfile = updated;\r\n      } else {\r\n        // Insert new profile with referral code\r\n        const { data: inserted, error: insertError } = await supabase\r\n          .from('profiles')\r\n          .insert({\r\n            email,\r\n            referral_code: finalCode,\r\n            first_name: email.split('@')[0],\r\n            last_name: '',\r\n          })\r\n          .select('referral_code')\r\n          .single();\r\n\r\n        if (insertError) {\r\n          console.error('Error creating referral code:', insertError);\r\n          return { success: false, error: insertError.message };\r\n        }\r\n        updatedProfile = inserted;\r\n      }\r\n\r\n      return { success: true, referralCode: updatedProfile?.referral_code || finalCode };\r\n    }\r\n\r\n    // Use the generated code from database function\r\n    // Update or insert profile with generated code\r\n    const { data: existingProfile } = await supabase\r\n      .from('profiles')\r\n      .select('id, first_name, last_name')\r\n      .eq('email', email)\r\n      .maybeSingle();\r\n\r\n    let updatedProfile;\r\n    if (existingProfile) {\r\n      // Update existing profile\r\n      const { data: updated, error: updateError } = await supabase\r\n        .from('profiles')\r\n        .update({\r\n          referral_code: generatedCode,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('email', email)\r\n        .select('referral_code')\r\n        .single();\r\n\r\n      if (updateError) {\r\n        console.error('Error updating referral code:', updateError);\r\n        return { success: false, error: updateError.message };\r\n      }\r\n      updatedProfile = updated;\r\n    } else {\r\n      // Insert new profile with referral code\r\n      const { data: inserted, error: insertError } = await supabase\r\n        .from('profiles')\r\n        .insert({\r\n          email,\r\n          referral_code: generatedCode,\r\n          first_name: email.split('@')[0],\r\n          last_name: '',\r\n        })\r\n        .select('referral_code')\r\n        .single();\r\n\r\n      if (insertError) {\r\n        console.error('Error creating referral code:', insertError);\r\n        return { success: false, error: insertError.message };\r\n      }\r\n      updatedProfile = inserted;\r\n    }\r\n\r\n    return { success: true, referralCode: updatedProfile?.referral_code || generatedCode };\r\n  } catch (error) {\r\n    console.error('Error in getOrCreateReferralCode:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to get referral code',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function sendReferralInvites(\r\n  email: string,\r\n  inviteEmails: string[],\r\n  referralCode: string\r\n): Promise<{\r\n  success: boolean;\r\n  sent?: number;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Validate email addresses\r\n    const validEmails = inviteEmails\r\n      .map((e) => e.trim())\r\n      .filter((e) => {\r\n        if (!e) return false;\r\n        return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(e);\r\n      });\r\n\r\n    if (validEmails.length === 0) {\r\n      return { success: false, error: 'No valid email addresses provided' };\r\n    }\r\n\r\n    // Create referral records for tracking\r\n    const referralRecords = validEmails.map((referredEmail) => ({\r\n      referrer_email: email,\r\n      referred_email: referredEmail,\r\n      referral_code: referralCode,\r\n      status: 'pending',\r\n    }));\r\n\r\n    const { error: insertError } = await supabase\r\n      .from('referrals')\r\n      .insert(referralRecords);\r\n\r\n    if (insertError) {\r\n      console.error('Error creating referral records:', insertError);\r\n      // Continue even if insert fails - we still want to send emails\r\n    }\r\n\r\n    // Generate referral link\r\n    const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://shalean.co.za';\r\n    const referralLink = `${baseUrl}/booking/details?ref=${referralCode}`;\r\n\r\n    // TODO: Implement actual email sending using your email service (Resend, SendGrid, etc.)\r\n    // For now, we'll just log the emails that would be sent\r\n    console.log('Referral invites to send:', {\r\n      from: email,\r\n      to: validEmails,\r\n      referralCode,\r\n      referralLink,\r\n    });\r\n\r\n    // In a real implementation, you would send emails here\r\n    // Example with Resend:\r\n    // await resend.emails.send({\r\n    //   from: 'Shalean <noreply@shalean.co.za>',\r\n    //   to: validEmails,\r\n    //   subject: 'You\\'ve been invited to try Shalean Cleaning Services!',\r\n    //   html: `<p>Your friend has invited you to try Shalean. Use code ${referralCode} to get R150 off your first booking!</p><p><a href=\"${referralLink}\">Book Now</a></p>`,\r\n    // });\r\n\r\n    return { success: true, sent: validEmails.length };\r\n  } catch (error) {\r\n    console.error('Error in sendReferralInvites:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to send invites',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getReferralStats(\r\n  email: string\r\n): Promise<{\r\n  success: boolean;\r\n  stats?: {\r\n    totalReferrals: number;\r\n    completedReferrals: number;\r\n    pendingRewards: number;\r\n    totalRewards: number;\r\n  };\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    const { data: referrals, error } = await supabase\r\n      .from('referrals')\r\n      .select('status, referrer_reward_amount, referrer_reward_status')\r\n      .eq('referrer_email', email);\r\n\r\n    if (error) {\r\n      console.error('Error fetching referral stats:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n\r\n    const stats = {\r\n      totalReferrals: referrals?.length || 0,\r\n      completedReferrals:\r\n        referrals?.filter((r) => r.status === 'completed').length || 0,\r\n      pendingRewards:\r\n        referrals?.filter((r) => r.referrer_reward_status === 'pending').length || 0,\r\n      totalRewards:\r\n        referrals\r\n          ?.filter((r) => r.referrer_reward_status === 'credited')\r\n          .reduce((sum, r) => sum + (r.referrer_reward_amount || 0), 0) || 0,\r\n    };\r\n\r\n    return { success: true, stats };\r\n  } catch (error) {\r\n    console.error('Error in getReferralStats:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to fetch referral stats',\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize a credit purchase with Paystack\r\n */\r\nexport async function initializeCreditPurchase(\r\n  email: string,\r\n  amount: number,\r\n  paymentMethod: 'credit_card' | 'eft'\r\n): Promise<{\r\n  success: boolean;\r\n  authorizationUrl?: string;\r\n  reference?: string;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    if (amount < 20 || amount > 5000) {\r\n      return {\r\n        success: false,\r\n        error: 'Amount must be between R20 and R5000',\r\n      };\r\n    }\r\n\r\n    // Generate a unique reference for this credit purchase\r\n    const reference = `CREDIT_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\r\n\r\n    // Create a pending credit transaction\r\n    const supabase = await createClient();\r\n    \r\n    // Get or create profile\r\n    let { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('id, credit_balance')\r\n      .eq('email', email)\r\n      .maybeSingle();\r\n\r\n    if (!profile) {\r\n      // Create a basic profile if it doesn't exist\r\n      const { data: newProfile, error: createError } = await supabase\r\n        .from('profiles')\r\n        .insert({\r\n          email,\r\n          credit_balance: 0,\r\n          first_name: '',\r\n          last_name: '',\r\n        })\r\n        .select('id, credit_balance')\r\n        .single();\r\n\r\n      if (createError || !newProfile) {\r\n        return {\r\n          success: false,\r\n          error: 'Failed to create profile',\r\n        };\r\n      }\r\n      profile = newProfile;\r\n    }\r\n\r\n    // Create pending credit transaction\r\n    const { error: transactionError } = await supabase\r\n      .from('credit_transactions')\r\n      .insert({\r\n        profile_id: profile.id,\r\n        email,\r\n        transaction_type: 'purchase',\r\n        amount,\r\n        balance_before: profile.credit_balance || 0,\r\n        balance_after: profile.credit_balance || 0, // Won't update until payment succeeds\r\n        payment_method: paymentMethod,\r\n        paystack_reference: reference,\r\n        payment_status: 'pending',\r\n        description: `Purchase of R${amount} ShaleanCred`,\r\n      });\r\n\r\n    if (transactionError) {\r\n      console.error('Error creating credit transaction:', transactionError);\r\n      return {\r\n        success: false,\r\n        error: 'Failed to create transaction record',\r\n      };\r\n    }\r\n\r\n    // Initialize Paystack payment\r\n    const response = await fetch('/api/paystack/initialize', {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n      },\r\n      body: JSON.stringify({\r\n        email,\r\n        amount,\r\n        reference,\r\n        metadata: {\r\n          transaction_type: 'credit_purchase',\r\n          payment_method: paymentMethod,\r\n        },\r\n      }),\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const error = await response.json();\r\n      return {\r\n        success: false,\r\n        error: error.error || 'Failed to initialize payment',\r\n      };\r\n    }\r\n\r\n    const paymentData = await response.json();\r\n\r\n    if (!paymentData.status) {\r\n      return {\r\n        success: false,\r\n        error: paymentData.message || 'Failed to initialize payment',\r\n      };\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      authorizationUrl: paymentData.data.authorization_url,\r\n      reference: paymentData.data.reference,\r\n    };\r\n  } catch (error) {\r\n    console.error('Error initializing credit purchase:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to initialize payment',\r\n    };\r\n  }\r\n}\r\n\r\nexport interface VoucherRedemption {\r\n  id: string;\r\n  voucher_code: string;\r\n  amount: number;\r\n  redeemed_at: string;\r\n  booking_id?: string;\r\n}\r\n\r\nexport async function redeemVoucher(\r\n  code: string,\r\n  email: string,\r\n  phone?: string\r\n): Promise<{\r\n  success: boolean;\r\n  amount?: number;\r\n  newBalance?: number;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Call the database function to redeem the voucher\r\n    const { data, error } = await supabase.rpc('redeem_voucher', {\r\n      p_code: code.trim().toUpperCase(),\r\n      p_email: email.trim(),\r\n      p_phone: phone?.trim() || null,\r\n    });\r\n\r\n    if (error) {\r\n      console.error('Error redeeming voucher:', error);\r\n      return {\r\n        success: false,\r\n        error: error.message || 'Failed to redeem voucher',\r\n      };\r\n    }\r\n\r\n    // Parse the result from the function (handle both object and string JSONB)\r\n    let result = data;\r\n    if (typeof data === 'string') {\r\n      try {\r\n        result = JSON.parse(data);\r\n      } catch (parseError) {\r\n        console.error('Error parsing voucher redemption result:', parseError);\r\n        return {\r\n          success: false,\r\n          error: 'Invalid response from server',\r\n        };\r\n      }\r\n    }\r\n\r\n    if (result && typeof result === 'object' && 'success' in result) {\r\n      if (result.success === false) {\r\n        return {\r\n          success: false,\r\n          error: result.error || 'Failed to redeem voucher',\r\n        };\r\n      }\r\n\r\n      return {\r\n        success: true,\r\n        amount: result.amount,\r\n        newBalance: result.new_balance,\r\n      };\r\n    }\r\n\r\n    return {\r\n      success: false,\r\n      error: 'Unexpected response from server',\r\n    };\r\n  } catch (error) {\r\n    console.error('Error in redeemVoucher:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to redeem voucher',\r\n    };\r\n  }\r\n}\r\n\r\nexport async function getVoucherRedemptions(\r\n  email: string,\r\n  phone?: string\r\n): Promise<{\r\n  success: boolean;\r\n  redemptions?: VoucherRedemption[];\r\n  error?: string;\r\n}> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    let query = supabase\r\n      .from('voucher_redemptions')\r\n      .select('id, voucher_code, amount, redeemed_at, booking_id')\r\n      .order('redeemed_at', { ascending: false });\r\n\r\n    // Build query for email/phone lookup\r\n    // Prioritize email as it's the primary identifier to prevent cross-account visibility\r\n    if (email) {\r\n      query = query.eq('email', email);\r\n      // If phone is also provided, we can optionally filter by both for extra security\r\n      // but email alone should be sufficient since it's unique\r\n    } else if (phone) {\r\n      query = query.eq('phone', phone);\r\n    } else {\r\n      return { success: false, error: 'Email or phone is required' };\r\n    }\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n      console.error('Error fetching voucher redemptions:', error);\r\n      return { success: false, error: error.message };\r\n    }\r\n\r\n    // Transform the data to match the interface\r\n    const redemptions: VoucherRedemption[] = (data || []).map((redemption) => ({\r\n      id: redemption.id,\r\n      voucher_code: redemption.voucher_code,\r\n      amount: redemption.amount,\r\n      redeemed_at: redemption.redeemed_at,\r\n      booking_id: redemption.booking_id || undefined,\r\n    }));\r\n\r\n    return { success: true, redemptions };\r\n  } catch (error) {\r\n    console.error('Error in getVoucherRedemptions:', error);\r\n    return {\r\n      success: false,\r\n      error: error instanceof Error ? error.message : 'Failed to fetch voucher redemptions',\r\n    };\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}