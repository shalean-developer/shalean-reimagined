module.exports=[88440,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(99570),e=a.i(91119),f=a.i(66718),g=a.i(23292);function h(){let[a,h]=(0,c.useState)(!1),[i,j]=(0,c.useState)(null),[k,l]=(0,c.useState)(null),[m,n]=(0,c.useState)(null),[o,p]=(0,c.useState)(!1),[q,r]=(0,c.useState)(null),[s,t]=(0,c.useState)(!1),[u,v]=(0,c.useState)(""),[w,x]=(0,c.useState)("849E23"),[y,z]=(0,c.useState)("farachits@gmail.com"),A=async(a,b)=>{let c=a||w,d=b||y;p(!0),n(null);try{let a=await fetch(`/api/referrals/check?referralCode=${encodeURIComponent(c)}&referredEmail=${encodeURIComponent(d)}`),b=await a.json();n(b)}catch(a){console.error("Error checking referral:",a)}finally{p(!1)}};(0,c.useEffect)(()=>{w&&y&&A(w,y)},[]);let B=async(a,b)=>{let c=a||w,d=b||y;h(!0),j(null),l(null);try{let a=await fetch("/api/bookings/verify-payments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referralCode:c,referredEmail:d})}),b=await a.json();if(!a.ok){l(b.error||"Failed to verify payments"),j(b),h(!1);return}if(b.updatedBookings>0||b.results?.some(a=>a.success)){let a=await fetch("/api/referrals/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referralCode:c,referredEmail:d})}),e=await a.json();a.ok?(j({paymentVerification:b,referralProcessing:e,success:e.success}),g.toast.success("Referral reward processed successfully!"),await A(c,d)):(l(e.error||"Failed to process referral"),j({paymentVerification:b,referralProcessing:e}))}else{let a=await fetch("/api/referrals/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referralCode:c,referredEmail:d})}),e=await a.json();a.ok?(j({paymentVerification:b,referralProcessing:e,success:e.success}),g.toast.success("Referral reward processed successfully!"),await A(c,d)):(l(e.error||"Failed to process referral"),j({paymentVerification:b,referralProcessing:e}))}}catch(a){l(a instanceof Error?a.message:"Unknown error occurred"),g.toast.error("Failed to process referral")}finally{h(!1)}};return(0,b.jsx)("div",{className:"container mx-auto py-10 max-w-4xl",children:(0,b.jsxs)(e.Card,{children:[(0,b.jsxs)(e.CardHeader,{children:[(0,b.jsx)(e.CardTitle,{children:"Fix Missing Referral Reward"}),(0,b.jsx)(e.CardDescription,{children:"Process missing referral rewards for any referral code and email combination"})]}),(0,b.jsxs)(e.CardContent,{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"text-sm font-medium mb-2 block",children:"Referral Code"}),(0,b.jsx)(f.Input,{type:"text",placeholder:"Enter referral code (e.g., 849E23)",value:w,onChange:a=>x(a.target.value.toUpperCase()),className:"font-mono"})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("label",{className:"text-sm font-medium mb-2 block",children:"Referred Email"}),(0,b.jsx)(f.Input,{type:"email",placeholder:"Enter referred email (e.g., farachits@gmail.com)",value:y,onChange:a=>z(a.target.value)})]}),(0,b.jsxs)("p",{className:"text-sm text-muted-foreground",children:[(0,b.jsx)("strong",{children:"Reward Amount:"})," R150.00"]})]}),(0,b.jsx)(d.Button,{onClick:()=>B(w,y),disabled:a||!w||!y,className:"w-full",children:a?"Processing...":"Process Referral Reward"}),k&&(0,b.jsxs)("div",{className:"p-4 bg-destructive/10 border border-destructive/20 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-destructive",children:"Error:"}),(0,b.jsx)("p",{className:"text-sm text-destructive/80",children:k})]}),i&&(0,b.jsxs)("div",{className:"p-4 bg-muted rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium mb-2",children:"Result:"}),(0,b.jsx)("pre",{className:"text-xs overflow-auto bg-background p-3 rounded border",children:JSON.stringify(i,null,2)})]}),i?.referralProcessing?.success&&(0,b.jsxs)("div",{className:"p-4 bg-green-50 border border-green-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-green-800",children:"✅ Success!"}),i.referralProcessing?.results?.map((a,c)=>(0,b.jsx)("div",{className:"mt-2 text-sm text-green-700",children:a.success?(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{children:["Booking ",a.bookingId,": R",a.rewardAmount," credited to ",a.referrerEmail]}),(0,b.jsxs)("p",{className:"text-xs",children:["Balance: R",a.balanceBefore," → R",a.balanceAfter]})]}):(0,b.jsxs)("p",{className:"text-amber-700",children:["⚠️ ",a.error]})},c))]}),(0,b.jsxs)("div",{className:"mt-6 border-t pt-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,b.jsx)("h3",{className:"text-lg font-semibold",children:"Referral Status Details"}),(0,b.jsx)(d.Button,{onClick:A,disabled:o,variant:"outline",size:"sm",children:o?"Checking...":"Refresh Status"})]}),m&&(0,b.jsx)("div",{className:"space-y-4",children:m.success?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-blue-800 mb-2",children:"Referrer Information"}),(0,b.jsxs)("p",{className:"text-sm text-blue-700",children:[(0,b.jsx)("strong",{children:"Email:"})," ",m.referrer.email]}),(0,b.jsxs)("p",{className:"text-sm text-blue-700",children:[(0,b.jsx)("strong",{children:"Name:"})," ",m.referrer.name]}),(0,b.jsxs)("p",{className:"text-sm text-blue-700 font-semibold",children:[(0,b.jsx)("strong",{children:"Current Credit Balance:"})," R",m.referrer.creditBalance.toFixed(2)]})]}),(0,b.jsxs)("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium mb-2",children:"Summary"}),(0,b.jsxs)("ul",{className:"text-sm space-y-1",children:[(0,b.jsxs)("li",{children:["Total Bookings: ",m.summary.totalBookings]}),(0,b.jsxs)("li",{children:["Paid Bookings: ",m.summary.paidBookings]}),(0,b.jsxs)("li",{children:["Total Referrals: ",m.summary.totalReferrals]}),(0,b.jsxs)("li",{children:["Credited Referrals: ",m.summary.creditedReferrals]}),(0,b.jsxs)("li",{className:"font-semibold text-green-700",children:["Total Rewards Credited: R",m.summary.totalRewardsCredited.toFixed(2)]})]})]}),m.rewardTransactions&&m.rewardTransactions.length>0&&(0,b.jsxs)("div",{className:"p-4 bg-green-50 border border-green-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-green-800 mb-2",children:"Reward Transactions"}),m.rewardTransactions.map((a,c)=>(0,b.jsxs)("div",{className:"text-sm text-green-700 mb-2 pb-2 border-b border-green-200 last:border-0",children:[(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Amount:"})," R",a.amount.toFixed(2)]}),(0,b.jsxs)("p",{className:"text-xs",children:[(0,b.jsx)("strong",{children:"Date:"})," ",new Date(a.created_at).toLocaleString()]}),(0,b.jsxs)("p",{className:"text-xs",children:[(0,b.jsx)("strong",{children:"Balance:"})," R",a.balance_before.toFixed(2)," → R",a.balance_after.toFixed(2)]}),a.description&&(0,b.jsxs)("p",{className:"text-xs",children:[(0,b.jsx)("strong",{children:"Description:"})," ",a.description]})]},c))]}),m.referrals&&m.referrals.length>0&&(0,b.jsxs)("div",{className:"p-4 bg-purple-50 border border-purple-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-purple-800 mb-2",children:"Referral Records"}),m.referrals.map((a,c)=>(0,b.jsxs)("div",{className:"text-sm text-purple-700 mb-2 pb-2 border-b border-purple-200 last:border-0",children:[(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Status:"})," ",a.status]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Reward Status:"})," ",a.referrer_reward_status]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Reward Amount:"})," R",a.referrer_reward_amount.toFixed(2)]}),(0,b.jsxs)("p",{className:"text-xs",children:[(0,b.jsx)("strong",{children:"Created:"})," ",new Date(a.created_at).toLocaleString()]}),a.updated_at&&(0,b.jsxs)("p",{className:"text-xs",children:[(0,b.jsx)("strong",{children:"Updated:"})," ",new Date(a.updated_at).toLocaleString()]})]},c))]})]}):(0,b.jsx)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-md",children:(0,b.jsx)("p",{className:"text-sm text-red-800",children:m.error})})})]}),q&&(0,b.jsxs)("div",{className:"border-t pt-6 mt-6",children:[(0,b.jsxs)("h3",{className:"text-lg font-semibold mb-4",children:["Debug Results for ",u]}),q.success?(0,b.jsxs)("div",{className:"space-y-4",children:[(0,b.jsxs)("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-blue-800 mb-2",children:"Analysis Summary"}),(0,b.jsxs)("ul",{className:"text-sm space-y-1",children:[(0,b.jsxs)("li",{children:["Total Bookings: ",q.analysis.totalBookings]}),(0,b.jsxs)("li",{children:["Paid Bookings: ",q.analysis.paidBookings]}),(0,b.jsxs)("li",{children:["Bookings with Referral Code: ",q.analysis.bookingsWithReferralCode]}),(0,b.jsxs)("li",{children:["Paid Bookings with Referral Code: ",q.analysis.paidBookingsWithReferralCode]}),(0,b.jsxs)("li",{children:["Total Referral Records: ",q.analysis.totalReferrals]}),(0,b.jsxs)("li",{children:["Completed Referrals: ",q.analysis.completedReferrals]}),(0,b.jsxs)("li",{children:["Credited Referrals: ",q.analysis.creditedReferrals]})]})]}),q.bookings&&q.bookings.length>0&&(0,b.jsxs)("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium mb-2",children:"Bookings"}),q.bookings.map((a,c)=>(0,b.jsxs)("div",{className:"text-sm mb-2 pb-2 border-b last:border-0",children:[(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Booking:"})," ",a.booking_number]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Referral Code:"})," ",a.referral_code||"None"]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Payment Status:"})," ",a.payment_status]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Status:"})," ",a.status]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Paystack Reference:"})," ",a.paystack_reference||"None"]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Transaction ID:"})," ",a.paystack_transaction_id||"None"]}),(0,b.jsxs)("p",{className:"text-xs text-gray-600",children:["Created: ",new Date(a.created_at).toLocaleString()]})]},c))]}),q.referrers&&q.referrers.length>0&&(0,b.jsxs)("div",{className:"p-4 bg-green-50 border border-green-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-green-800 mb-2",children:"Referrer(s)"}),q.referrers.map((a,c)=>(0,b.jsxs)("div",{className:"text-sm mb-3 pb-3 border-b border-green-200 last:border-0",children:[(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Email:"})," ",a.email]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Referral Code:"})," ",a.referralCode]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Credit Balance:"})," R",a.credit_balance.toFixed(2)]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Reward Transactions:"})," ",a.rewardTransactions.length]}),a.rewardTransactions.length>0&&(0,b.jsx)("div",{className:"mt-2 text-xs",children:a.rewardTransactions.map((a,c)=>(0,b.jsxs)("div",{className:"mb-1",children:["R",a.amount.toFixed(2)," - ",new Date(a.created_at).toLocaleString()]},c))})]},c))]}),q.referrals&&q.referrals.length>0&&(0,b.jsxs)("div",{className:"p-4 bg-purple-50 border border-purple-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-purple-800 mb-2",children:"Referral Records"}),q.referrals.map((a,c)=>(0,b.jsxs)("div",{className:"text-sm mb-2 pb-2 border-b border-purple-200 last:border-0",children:[(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Referrer:"})," ",a.referrer_email]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Code:"})," ",a.referral_code]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Status:"})," ",a.status]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Reward Status:"})," ",a.referrer_reward_status]}),(0,b.jsxs)("p",{children:[(0,b.jsx)("strong",{children:"Reward Amount:"})," R",a.referrer_reward_amount.toFixed(2)]})]},c))]}),q.analysis.paidBookingsWithReferralCode>0&&0===q.analysis.creditedReferrals&&(0,b.jsxs)("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-md",children:[(0,b.jsx)("p",{className:"text-sm font-medium text-yellow-800 mb-2",children:"⚠️ Issue Detected: Paid bookings with referral code but no credited rewards"}),(0,b.jsx)(d.Button,{onClick:async()=>{let a=q.bookings.find(a=>"paid"===a.payment_status&&a.referral_code);if(a&&u){h(!0),l(null);try{let b=await fetch("/api/bookings/verify-payments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referralCode:a.referral_code,referredEmail:u})});await b.json();let c=await fetch("/api/referrals/process",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({referralCode:a.referral_code,referredEmail:u})}),d=await c.json();if(c.ok&&d.success){g.toast.success("Referral reward processed successfully!");let a=await fetch(`/api/referrals/debug?referredEmail=${encodeURIComponent(u)}`),b=await a.json();r(b)}else g.toast.error(d.error||"Failed to process referral"),l(d.error||"Failed to process referral")}catch(a){g.toast.error("Failed to process referral"),l(a instanceof Error?a.message:"Unknown error")}finally{h(!1)}}},className:"mt-2",disabled:a,children:a?"Processing...":"Process Missing Reward"})]})]}):(0,b.jsx)("div",{className:"p-4 bg-red-50 border border-red-200 rounded-md",children:(0,b.jsx)("p",{className:"text-sm text-red-800",children:q.error})})]})]})]})})}a.s(["default",()=>h])}];

//# sourceMappingURL=app_admin_fix-referral_page_tsx_6e130921._.js.map