module.exports=[30226,a=>{"use strict";var b=a.i(37936),c=a.i(72936),d=a.i(13095);async function e(){try{let a=await (0,c.createClient)(),{data:b,error:d}=await a.from("pricing_rules").select("*").eq("is_active",!0).order("display_order",{ascending:!0});if(d)return console.error("Error fetching pricing rules:",d),[];return b||[]}catch(a){return console.error("Unexpected error fetching pricing rules:",a),[]}}async function f(a){let b=(await e()).find(b=>"base_price"===b.rule_type&&b.service_id===a);return b?.price||0}async function g(a){let b=(await e()).find(b=>"bedroom"===b.rule_type&&b.rule_value===a);return b?.price||0}async function h(a){let b=(await e()).find(b=>"bathroom"===b.rule_type&&b.rule_value===a);return b?.price||0}async function i(a){let b=(await e()).find(b=>"additional_service"===b.rule_type&&b.additional_service_id===a);return b?.price||0}async function j(){let a=(await e()).find(a=>"service_fee"===a.rule_type);return a?.percentage||0}async function k(a){let b=(await e()).find(b=>"frequency_discount"===b.rule_type&&b.rule_value===a);return b?.percentage||0}async function l(){let a=(await e()).find(a=>"fitted_room"===a.rule_type&&"per_room"===a.rule_key);return a?.price||0}async function m(){let a=(await e()).find(a=>"loose_carpet"===a.rule_type&&"per_carpet"===a.rule_key);return a?.price||0}function n(a){if(!a)return!1;let b=a.toLowerCase().trim();return!!(b.includes("standard")||b.includes("airbnb"))}async function o(a){let{serviceId:b,serviceName:c,bedrooms:d,bathrooms:e,additionalServiceIds:o,additionalServices:p=[],cleaningFrequency:q,discountAmount:r=0,numberOfFittedRooms:s="",numberOfLooseCarpets:t="",isCarpetCleaning:u=!1,cleaningEquipment:v="",numberOfCleaners:w=1}=a,x=await f(b),y=u?0:await g(d),z=u?0:await h(e),A=await l()*(parseFloat(s)||0),B=await m()*(parseFloat(t)||0),C=0;for(let a of o){let b=await i(a),c=p.find(b=>b.id===a);c?.requires_quantity,C+=b}let D=0;"yes"===v&&c&&n(c)&&(D=500);let E=0;c&&n(c)&&w>1&&(E=250*Math.max(0,Math.min(w-1,4)));let F=x+y+z+A+B+C+D+E,G=0,H=0;"one-time"!==q&&c&&""!==c.trim()&&n(c)&&(H=F*(G=await k(q))/100);let I=F-H,J=Math.max(0,I-r),K=I*await j()/100;return{basePrice:x,bedroomsPrice:y,bathroomsPrice:z,fittedRoomsPrice:A,looseCarpetsPrice:B,additionalServicesPrice:C,equipmentSupplyPrice:D,additionalCleanersPrice:E,subtotal:F,frequencyDiscountPercent:G,frequencyDiscountAmount:H,discountAmount:r,serviceFee:K,totalAmount:J+K}}async function p(a,b,c,d,e,f=0,g="",h="",i=!1,j,k,l=1){return o({serviceId:a,serviceName:j,bedrooms:b,bathrooms:c,additionalServiceIds:d,cleaningFrequency:e,discountAmount:f,numberOfFittedRooms:g,numberOfLooseCarpets:h,isCarpetCleaning:i,cleaningEquipment:k,numberOfCleaners:l})}(0,d.ensureServerEntryExports)([e,f,g,h,i,j,k,l,m]),(0,b.registerServerReference)(e,"00e68045b50ec07d1755fc7bc74581b353d37ec3d0",null),(0,b.registerServerReference)(f,"40b3e41c599ca115a2cca5d6967b86aeae096f5cce",null),(0,b.registerServerReference)(g,"407a0c9fe131443d583c59e091a1b9cdb277c64ba3",null),(0,b.registerServerReference)(h,"404fcf2f2031794cdecdea7fe841b00dcda4360c61",null),(0,b.registerServerReference)(i,"40ccca73e290a1009e293e3b28c989c1d66a8b3690",null),(0,b.registerServerReference)(j,"002ec01673d71389c24b8333c933b7d99e07a79364",null),(0,b.registerServerReference)(k,"40012760c2502a632427da471d267365b6bb590b70",null),(0,b.registerServerReference)(l,"00e8977a4d1164767b769a01a292ba7415706fb934",null),(0,b.registerServerReference)(m,"003e753166276d1e97b42fa21c960fab0a21ea9a7b",null),(0,d.ensureServerEntryExports)([o,p]),(0,b.registerServerReference)(o,"4080a015f076f9abd84630723e1126a06fc2a2f3de",null),(0,b.registerServerReference)(p,"7f2bb1906fcfe166da78d502275e8b6157dcee9f53",null);let q=process.env.PAYSTACK_SECRET_KEY;async function r(a,b,c,d){if(!q)throw Error("Paystack secret key is not configured");let e=Math.round(100*b),f=`http://localhost:3000/payment/success?reference=${c}`,g=await fetch("https://api.paystack.co/transaction/initialize",{method:"POST",headers:{Authorization:`Bearer ${q}`,"Content-Type":"application/json"},body:JSON.stringify({email:a,amount:e,reference:c,metadata:d,currency:"ZAR",callback_url:f})});if(!g.ok)throw Error((await g.json()).message||"Failed to initialize payment");return g.json()}function s(a){let b=a.total_bookings||0,c=a.completed_bookings||0,d=a.on_time_bookings||0,e=a.rating||0;if(0===b)return 50;let f=10*Math.min(b/50,1),g=c/b*40+d/b*30+e/5*20+f;return Math.round(100*(g=Math.max(0,Math.min(100,g))))/100}function t(a){let b=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,"0"),d=String(a.getDate()).padStart(2,"0");return`${b}-${c}-${d}`}async function u(){try{let a=await (0,c.createClient)(),{data:b,error:d}=await a.from("working_hours").select("*").eq("is_active",!0).order("display_order",{ascending:!0});if(d)return console.error("Error fetching working hours:",d),[];return b||[]}catch(a){return console.error("Unexpected error fetching working hours:",a),[]}}async function v(){try{let a=await (0,c.createClient)(),{data:b,error:d}=await a.from("home_detail_options").select("value, label").eq("option_type","working_hours").eq("is_active",!0).order("display_order",{ascending:!0});if(d)return console.error("Error fetching working hours from options:",d),[];return(b||[]).map(a=>({value:a.value,label:a.label}))}catch(a){return console.error("Unexpected error fetching working hours from options:",a),[]}}async function w(a,b,d){try{let e=await (0,c.createClient)(),{data:f,error:g}=await e.from("cleaners").select("id").eq("is_active",!0);if(g)return console.error("Error checking active cleaners:",g),{available:!1,availableCleanersCount:0};if(!f||0===f.length)return{available:!1,availableCleanersCount:0};let h=f.length,{data:i,error:j}=await e.from("bookings").select("service_time, service_duration, preferred_cleaner_id, preferred_cleaner_ids, number_of_cleaners").eq("service_date",a).in("status",["pending","confirmed"]);if(j)return console.error("Error checking bookings:",j),{available:!0,availableCleanersCount:h};if(!i||0===i.length)return{available:!0,availableCleanersCount:h};let[k,l]=b.split(":").map(Number),m=60*k+l,n=Math.round(60*d),o=m+n,p=new Set;for(let a of i){if(!a.service_time)continue;let[b,c]=a.service_time.split(":").slice(0,2).map(Number),d=60*b+c,e=Math.round(("number"==typeof a.service_duration?a.service_duration:parseFloat(a.service_duration||"0"))*60),f=d+e;m<f&&o>d&&(a.preferred_cleaner_ids&&Array.isArray(a.preferred_cleaner_ids)?a.preferred_cleaner_ids.forEach(a=>{a&&p.add(a)}):a.preferred_cleaner_id?p.add(a.preferred_cleaner_id):a.number_of_cleaners)}let q=i.filter(a=>{if(a.preferred_cleaner_ids&&Array.isArray(a.preferred_cleaner_ids)&&a.preferred_cleaner_ids.length>0||a.preferred_cleaner_id)return!1;let[b,c]=a.service_time.split(":").slice(0,2).map(Number),d=60*b+c,e=Math.round(("number"==typeof a.service_duration?a.service_duration:parseFloat(a.service_duration||"0"))*60);return m<d+e&&o>d}).reduce((a,b)=>a+(b.number_of_cleaners||1),0),r=p.size+q,s=Math.max(0,h-r);return{available:s>0,availableCleanersCount:s}}catch(a){return console.error("Unexpected error checking cleaner availability:",a),{available:!1,availableCleanersCount:0}}}async function x(a,b,c){let d={},e=b.map(async b=>{let d=await w(a,b.start_time,c);return{time:b.start_time,availability:d}});return(await Promise.all(e)).forEach(({time:a,availability:b})=>{d[a]=b}),d}async function y(a,b){try{if(!a||!a.trim())return{valid:!1,discountAmount:0,error:"Discount code is required"};let d=await (0,c.createClient)(),{data:e,error:f}=await d.from("discount_codes").select("*").eq("code",a.trim().toUpperCase()).eq("is_active",!0).single();if(f||!e)return{valid:!1,discountAmount:0,error:"Invalid discount code"};let g=new Date,h=new Date(e.valid_from),i=new Date(e.valid_until);if(g<h||g>i)return{valid:!1,discountAmount:0,error:"Discount code has expired"};if(e.max_uses&&e.used_count>=e.max_uses)return{valid:!1,discountAmount:0,error:"Discount code has reached maximum uses"};if(e.min_purchase_amount&&b<e.min_purchase_amount)return{valid:!1,discountAmount:0,error:`Minimum purchase amount of R${e.min_purchase_amount} required`};let j=0;return"percentage"===e.discount_type?(j=b*e.discount_value/100,e.max_discount_amount&&j>e.max_discount_amount&&(j=e.max_discount_amount)):j=e.discount_value,j=Math.min(j,b),{valid:!0,discountAmount:j}}catch(a){return console.error("Error validating discount code:",a),{valid:!1,discountAmount:0,error:"Error validating discount code"}}}async function z(a){try{var b,d;let e=await (0,c.createClient)(),{data:{user:f}}=await e.auth.getUser(),g=f?.id||null,{data:h}=await e.from("services").select("name").eq("id",a.serviceId).single();if(!h)return{success:!1,error:"Service not found"};if(b=h.name,d=a.cleaningFrequency,!(n(b)?["one-time","weekly","bi-weekly","monthly"]:["one-time"]).includes(d))return{success:!1,error:`Recurring bookings are only available for Standard Cleaning and Airbnb Cleaning services. Selected service: ${h.name}`};let i=await o({serviceId:a.serviceId,serviceName:h.name,bedrooms:a.bedrooms,bathrooms:a.bathrooms,additionalServiceIds:a.additionalServices,cleaningFrequency:a.cleaningFrequency,discountAmount:0,cleaningEquipment:a.cleaningEquipment,numberOfCleaners:a.numberOfCleaners||1}),j=0;if(a.discountCode){let b=await y(a.discountCode,i.subtotal-i.frequencyDiscountAmount);b.valid&&(j=b.discountAmount)}let k=await o({serviceId:a.serviceId,serviceName:h.name,bedrooms:a.bedrooms,bathrooms:a.bathrooms,additionalServiceIds:a.additionalServices,cleaningFrequency:a.cleaningFrequency,discountAmount:j,cleaningEquipment:a.cleaningEquipment,numberOfCleaners:a.numberOfCleaners||1}),l="one-time"!==a.cleaningFrequency,m=new Date(a.serviceDate),p=function(a,b){let c=[],d=new Date(a),e=d.getMonth(),f=d.getFullYear(),g=new Date(f,e+1,0).getDate();switch(b){case"one-time":case"monthly":default:c.push(new Date(a));break;case"weekly":d.getDay();let h=new Date(f,e,d.getDate());for(;h.getMonth()===e&&h.getDate()<=g;)c.push(new Date(h)),h.setDate(h.getDate()+7);break;case"bi-weekly":let i=new Date(f,e,d.getDate());for(;i.getMonth()===e&&i.getDate()<=g;)c.push(new Date(i)),i.setDate(i.getDate()+14)}return c}(m,a.cleaningFrequency),q=null;if(l&&p.length>0){let b=p[p.length-1];q=function(a,b){let c=new Date(a);switch(b){case"one-time":default:c.setMonth(c.getMonth()+1);break;case"weekly":c.setMonth(c.getMonth()+1);let d=a.getDay();for(a.getDate(),c.setDate(1);c.getDay()!==d;)c.setDate(c.getDate()+1);break;case"bi-weekly":c.setMonth(c.getMonth()+1);let e=a.getDay();for(c.setDate(1);c.getDay()!==e;)c.setDate(c.getDate()+1);break;case"monthly":c.setMonth(c.getMonth()+1);let f=a.getDate(),g=new Date(c.getFullYear(),c.getMonth()+1,0).getDate();c.setDate(Math.min(f,g))}return c}(b,a.cleaningFrequency)}let r=[];for(let b=0;b<p.length;b++){let c=p[b],d=function(){let a=new Date,b=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,"0"),d=String(a.getDate()).padStart(2,"0"),e=Math.floor(1e6*Math.random()).toString().padStart(6,"0");return`SHL${b}${c}${d}${e}`}(),e=0===b&&a.tipAmount||0,f={booking_number:d,customer_first_name:a.customerFirstName,customer_last_name:a.customerLastName,customer_email:a.customerEmail,customer_phone:a.customerPhone,service_id:a.serviceId,service_type:h.name,bedrooms:a.bedrooms,bathrooms:a.bathrooms,additional_services:a.additionalServices,cleaning_equipment:a.cleaningEquipment,preferred_cleaner_ids:a.preferredCleanerIds&&a.preferredCleanerIds.length>0?a.preferredCleanerIds:null,preferred_cleaner_id:a.preferredCleanerIds&&a.preferredCleanerIds.length>0?a.preferredCleanerIds[0]:null,cleaning_frequency:a.cleaningFrequency,service_date:t(c),service_time:a.serviceTime,service_duration:a.serviceDuration,service_address:a.serviceAddress,service_apt_unit:a.serviceAptUnit||null,service_suburb:a.serviceSuburb,service_city:a.serviceCity,special_instructions:a.specialInstructions||null,tip_amount:e,base_price:k.basePrice,additional_services_price:k.additionalServicesPrice,equipment_supply_price:k.equipmentSupplyPrice,number_of_cleaners:a.numberOfCleaners||1,additional_cleaners_price:k.additionalCleanersPrice,frequency_discount_percent:k.frequencyDiscountPercent,frequency_discount_amount:k.frequencyDiscountAmount,subtotal:k.subtotal,service_fee:k.serviceFee,total_amount:k.totalAmount+e,discount_code:a.discountCode||null,discount_amount:j,referral_code:a.referralCode||null,amount_paid:0,payment_status:"pending",status:"pending",user_id:g,parent_booking_id:null,is_recurring:l,recurrence_status:l?"active":void 0,next_booking_date:0===b&&l&&q?t(q):null};r.push(f)}let{data:s,error:u}=await e.from("bookings").insert(r).select("id, total_amount");if(u)return console.error("Error creating booking drafts:",u),{success:!1,error:u.message};if(!s||0===s.length)return{success:!1,error:"Failed to create bookings"};if(s.length>1&&l){let a=s[0].id,b=s.slice(1).map(a=>a.id),{error:c}=await e.from("bookings").update({parent_booking_id:a}).in("id",b);c&&console.error("Error updating parent_booking_id:",c)}let v=s.reduce((a,b)=>a+Number(b.total_amount),0),w=s.map(a=>a.id),x=w[0];if(w.length>1)return{success:!0,bookingIds:w,totalAmount:v,bookingId:x};return{success:!0,bookingId:x,bookingIds:w,totalAmount:v}}catch(a){return console.error("Unexpected error creating booking draft:",a),{success:!1,error:a instanceof Error?a.message:"An unexpected error occurred"}}}async function A(a){try{let b=await (0,c.createClient)(),d=Array.isArray(a)?a:[a],{data:e,error:f}=await b.from("bookings").select("*").in("id",d);if(f||!e||0===e.length)return{success:!1,error:"Booking(s) not found"};if(e.filter(a=>"pending"!==a.payment_status).length>0)return{success:!1,error:"Some bookings are not in pending payment status"};let g=e.reduce((a,b)=>{let c=Number(b.total_amount)||0,d=Number(b.tip_amount)||0,e=Number(b.subtotal||0)+Number(b.service_fee||0);return d>0&&.01>Math.abs(c-e)?a+c+d:a+c},0),h=e[0],i=h.paystack_reference||`${h.booking_number}${Date.now()}`,j=await r(h.customer_email,g,i,{booking_ids:d,booking_id:h.id,booking_number:h.booking_number,customer_email:h.customer_email});if(!j.status)return{success:!1,error:j.message||"Failed to initialize payment"};let k=j.data.reference,{error:l}=await b.from("bookings").update({paystack_reference:k}).in("id",d);return l&&console.error("Error updating bookings with Paystack reference:",l),{success:!0,authorizationUrl:j.data.authorization_url,reference:k}}catch(a){return console.error("Error initializing payment:",a),{success:!1,error:a instanceof Error?a.message:"Failed to initialize payment"}}}async function B(a){try{let b=await (0,c.createClient)(),{data:d,error:e}=await b.from("bookings").select("*").eq("id",a).single();if(e)return console.error("Error fetching booking:",e),{success:!1,error:"Booking not found"};return{success:!0,booking:d}}catch(a){return console.error("Unexpected error fetching booking:",a),{success:!1,error:a instanceof Error?a.message:"An unexpected error occurred"}}}async function C(a){try{let b=(await (0,c.createClient)()).from("cleaners").select("*").eq("is_active",!0),{data:d,error:e}=await b.order("rating",{ascending:!1}).order("name",{ascending:!0});if(e)return console.error("Error fetching cleaners:",e),{success:!1,error:"Failed to fetch cleaners"};let f=d||[];if(f=f.filter(a=>!1!==a.is_available),a&&f.length>0){let b=a.toLowerCase().trim();f=f.filter(a=>!a.areas||0===a.areas.length||a.areas.some(a=>{let c=a.toLowerCase();return c.includes(b)||b.includes(c)}))}return{success:!0,cleaners:f}}catch(a){return console.error("Unexpected error fetching cleaners:",a),{success:!1,error:a instanceof Error?a.message:"An unexpected error occurred"}}}async function D(a,b){return!1!==a[({0:"available_sunday",1:"available_monday",2:"available_tuesday",3:"available_wednesday",4:"available_thursday",5:"available_friday",6:"available_saturday"})[b]]&&!1!==a.is_available}async function E(a,b,d,e){try{let f=await (0,c.createClient)(),{data:g,error:h}=await f.from("bookings").select("service_time, service_duration").eq("preferred_cleaner_id",a).eq("service_date",b).in("status",["pending","confirmed"]);if(h)return console.error("Error checking booking conflicts:",h),!1;if(!g||0===g.length)return!1;let[i,j]=d.split(":").map(Number),k=60*i+j,l=Math.round(60*e),m=k+l;for(let a of g){if(!a.service_time)continue;let[b,c]=a.service_time.split(":").slice(0,2).map(Number),d=60*b+c,e=Math.round(("number"==typeof a.service_duration?a.service_duration:parseFloat(a.service_duration||"0"))*60),f=d+e;if(k<f&&m>d)return!0}return!1}catch(a){return console.error("Unexpected error checking booking conflict:",a),!1}}async function F(a){try{let b=await (0,c.createClient)(),{data:d,error:e}=await b.rpc("calculate_cleaner_reliability_score",{cleaner_id:a});if(!e&&null!==d)return parseFloat(d.toString());let{data:f,error:g}=await b.from("cleaners").select("*").eq("id",a).single();if(g||!f)return 50;return s(f)}catch(a){return console.error("Error calculating reliability score:",a),50}}async function G(a){try{let b=await (0,c.createClient)(),{serviceSuburb:d,serviceDate:e,serviceTime:f,serviceDuration:g=3,minRating:h=0,minReliabilityScore:i=0}=a,j=b.from("cleaners").select("*").eq("is_active",!0),{data:k,error:l}=await j.order("reliability_score",{ascending:!1,nullsFirst:!1}).order("rating",{ascending:!1}).order("name",{ascending:!0});if(l)return console.error("Error fetching cleaners:",l),{success:!1,error:"Failed to fetch cleaners"};let m=k||[];if(m=m.filter(a=>!1!==a.is_available),d&&m.length>0){let a=d.toLowerCase().trim();m=m.filter(b=>!b.areas||0===b.areas.length||b.areas.some(b=>{let c=b.toLowerCase();return c.includes(a)||a.includes(c)}))}if(e){let a=new Date(e).getDay();m=m.filter(b=>!1!==b[({0:"available_sunday",1:"available_monday",2:"available_tuesday",3:"available_wednesday",4:"available_thursday",5:"available_friday",6:"available_saturday"})[a]])}h>0&&(m=m.filter(a=>(a.rating||0)>=h)),i>0&&(m=m.filter(a=>(a.reliability_score||0)>=i));let n=await Promise.all(m.map(async a=>{let b,c,d,h,i=!0,j=!1;e&&f&&g&&(i=!(j=await E(a.id,e,f,g)));let k=a.reliability_score??s(a);return{...a,reliability_score:k,isAvailableForSlot:i,bookingConflict:j,completionRate:(b=a.total_bookings||0,c=a.completed_bookings||0,0===b?0:Math.round(c/b*100)),onTimeRate:(d=a.total_bookings||0,h=a.on_time_bookings||0,0===d?0:Math.round(h/d*100))}}));return n.sort((a,b)=>{let c=.6*(a.reliability_score||0)+.4*(a.rating||0);return .6*(b.reliability_score||0)+.4*(b.rating||0)-c}),{success:!0,cleaners:n}}catch(a){return console.error("Unexpected error fetching cleaners with criteria:",a),{success:!1,error:a instanceof Error?a.message:"An unexpected error occurred"}}}(0,d.ensureServerEntryExports)([u,v,w,x,y,z,A,B,C,D,E,F,G]),(0,b.registerServerReference)(u,"002f2abc3677e869298b74e0b52ead1d3096ac9f66",null),(0,b.registerServerReference)(v,"00d01b934d9d6a3f1077d04df6441f592ce986a493",null),(0,b.registerServerReference)(w,"70a5158f518751925351faa8d312dcdf278a2eda44",null),(0,b.registerServerReference)(x,"70959ca63333f4e34442b0b835d429af0b90998e3e",null),(0,b.registerServerReference)(y,"60bf64c7595e42167f2bb61b3c1cf32233840f6b11",null),(0,b.registerServerReference)(z,"4058c82389d1b0af01e0ab7f3166467c8d163c3dfb",null),(0,b.registerServerReference)(A,"40856064b0b8a033c99fb4eb0cd1dcbe900869365a",null),(0,b.registerServerReference)(B,"4019077b570b948a0ce0bdaa6a6ff3658da4c84eee",null),(0,b.registerServerReference)(C,"40f7a0d4de260d93ec6654ab7a002557b9974bd1eb",null),(0,b.registerServerReference)(D,"60a1fba6bf9f28d6425e87658b21ba8d567efc7280",null),(0,b.registerServerReference)(E,"7838c638d078aa6a15b11354a5f9f37a0b26533ca2",null),(0,b.registerServerReference)(F,"408afb0052d1a666641316206bf9f0551e67df1370",null),(0,b.registerServerReference)(G,"409aec5f16081da101cf78f4bfd036d2f21ddd4c57",null),a.s(["checkAvailabilityForAllSlots",()=>x,"createBookingDraft",()=>z,"getBooking",()=>B,"getWorkingHours",()=>u,"getWorkingHoursFromOptions",()=>v,"initializePaymentForBooking",()=>A,"validateDiscountCode",()=>y],30226)}];

//# sourceMappingURL=app_booking_book_actions_ts_93f0005c._.js.map