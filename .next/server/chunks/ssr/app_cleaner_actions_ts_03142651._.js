module.exports=[5293,a=>{"use strict";var b=a.i(37936),c=a.i(72936),d=a.i(55792);function e(a){if(!a)return 0;let b="string"==typeof a?new Date(a):a;return Math.max(0,(new Date().getTime()-b.getTime())/864e5/30)}function f(a){return a&&0!==a.length?a.filter(a=>"completed"===a.status&&"paid"===a.payment_status).reduce((a,b)=>a+(Number(b.service_duration)||0),0):0}function g(a,b){return a>=3&&b>=400?.7:.6}function h(a,b,c,d){if(function(a){if(!a)return!1;let b=a.toLowerCase().trim();return!!(b.includes("deep")||b.includes("move")&&(b.includes("in/out")||b.includes("in out")||b.includes("inout"))||b.includes("carpet"))}(a.service_type))return 250;let e=Number(a.equipment_supply_price)||0,f=Number(a.additional_cleaners_price)||0,g=(Number(a.total_amount)||0)-(Number(a.service_fee)||0)-e,h=1;return d&&Array.isArray(d)&&d.length>0?h=d.length:a.preferred_cleaner_ids&&Array.isArray(a.preferred_cleaner_ids)&&a.preferred_cleaner_ids.length>0?h=a.preferred_cleaner_ids.length:a.preferred_cleaner_id&&(h=1),(g*c+f)/h}function i(a,b,c){let d=Number(a)||0;if(d<=0)return 0;let e=1;return b&&Array.isArray(b)&&b.length>0?e=b.length:c&&(e=1),d/e}function j(a,b,c){return h(a,b,c,a.preferred_cleaner_ids||null)+i(a.tip_amount||0,a.preferred_cleaner_ids,a.preferred_cleaner_id)}async function k(a){try{let b=await (0,c.createClient)(),d=a.replace(/\s+/g,"").trim(),{data:e,error:f}=await b.from("cleaners").select("*").or(`phone.eq.${d},phone.eq.+${d}`).eq("is_active",!0).maybeSingle();if(f)return console.error("Error fetching cleaner by phone:",f),{success:!1,error:f.message};if(!e)return{success:!1,error:"Cleaner not found"};return{success:!0,cleaner:e}}catch(a){return console.error("Error in getCleanerByPhone:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch cleaner"}}}async function l(a,b){try{let e=await k(a);if(!e.success||!e.cleaner)return{success:!1,error:"Invalid phone number or password"};let f=e.cleaner,g=a.replace(/\s+/g,"").trim(),h=`${g}@cleaners.shalean.local`,i=await (0,c.createClient)(),{data:j,error:l}=await i.auth.signInWithPassword({email:h,password:b});if(l)return console.error("Authentication error:",l),{success:!1,error:"Invalid phone number or password"};if(!j.user)return{success:!1,error:"Authentication failed"};if(!f.auth_user_id)try{let a=(0,d.createAdminClient)();await a.from("cleaners").update({auth_user_id:j.user.id}).eq("id",f.id)}catch(a){console.warn("Could not update auth_user_id:",a)}return{success:!0,cleaner:f}}catch(a){return console.error("Error in authenticateCleaner:",a),{success:!1,error:a instanceof Error?a.message:"Authentication failed"}}}async function m(){try{let a=await (0,c.createClient)(),{data:{user:b},error:d}=await a.auth.getUser();if(d||!b)return{success:!1,error:"Not authenticated"};let e=a.from("cleaners").select("*").eq("auth_user_id",b.id).eq("is_active",!0).maybeSingle(),{data:f,error:g}=await e;if(!f&&!g&&b.email){let a=b.email.match(/^(.+)@cleaners\.shalean\.local$/);if(a){let b=a[1],c=await k(b);c.success&&c.cleaner&&(f=c.cleaner)}}if(g||!f)return{success:!1,error:"Cleaner profile not found"};return{success:!0,cleaner:f}}catch(a){return console.error("Error in getCurrentCleaner:",a),{success:!1,error:a instanceof Error?a.message:"Failed to get cleaner"}}}async function n(a){try{let b=await m();if(!b.success||!b.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let d=b.cleaner.id,e=await (0,c.createClient)(),f=e.from("bookings").select("*").eq("preferred_cleaner_id",d),g=e.from("bookings").select("*").not("preferred_cleaner_ids","is",null);if(a&&"all"!==a){let b=new Date().toISOString().split("T")[0];switch(a){case"today":f=f.eq("service_date",b),g=g.eq("service_date",b);break;case"upcoming":f=f.gte("service_date",b).in("status",["pending","confirmed","on_my_way","started"]),g=g.gte("service_date",b).in("status",["pending","confirmed","on_my_way","started"]);break;case"past":f=f.lt("service_date",b).or("status.eq.completed,status.eq.cancelled"),g=g.lt("service_date",b).or("status.eq.completed,status.eq.cancelled");break;case"on_my_way":f=f.eq("status","on_my_way"),g=g.eq("status","on_my_way");break;case"started":f=f.eq("status","started"),g=g.eq("status","started")}}let[h,i]=await Promise.all([f.order("service_date",{ascending:!0}).order("service_time",{ascending:!0}),g.order("service_date",{ascending:!0}).order("service_time",{ascending:!0})]);if(h.error)return console.error("Error fetching cleaner bookings (single):",h.error),{success:!1,error:h.error.message};if(i.error)return console.error("Error fetching cleaner bookings (array):",i.error),{success:!1,error:i.error.message};console.log("[getCleanerBookings] Fetched bookings:",{cleanerId:d,filter:a,singleBookingsCount:h.data?.length||0,arrayBookingsCount:i.data?.length||0});let j=a=>a?String(a).toLowerCase().trim():"",k=j(d),l=(i.data||[]).filter(a=>!!a.preferred_cleaner_ids&&!!Array.isArray(a.preferred_cleaner_ids)&&0!==a.preferred_cleaner_ids.length&&a.preferred_cleaner_ids.some(a=>j(a)===k)),n=[...h.data||[],...l],o=new Map;n.forEach(a=>{a.id&&!o.has(a.id)&&o.set(a.id,a)});let p=Array.from(o.values());return p.sort((a,b)=>{let c=a.service_date.localeCompare(b.service_date);return 0!==c?c:a.service_time.localeCompare(b.service_time)}),{success:!0,bookings:p}}catch(a){return console.error("Error in getCleanerBookings:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch bookings"}}}async function o(a){try{let b=await m();if(!b.success||!b.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let d=b.cleaner.id,j=await (0,c.createClient)(),{data:k,error:l}=await j.from("cleaners").select("created_at").eq("id",d).maybeSingle();if(l||!k)return{success:!1,error:"Cleaner not found"};let{data:n,error:o}=await j.from("bookings").select("*").eq("id",a).maybeSingle();if(o||!n)return{success:!1,error:"Booking not found"};let{data:p}=await j.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").eq("preferred_cleaner_id",d),{data:q}=await j.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").not("preferred_cleaner_ids","is",null),r=a=>a?String(a).toLowerCase().trim():"",s=r(d),t=(q||[]).filter(a=>!!a.preferred_cleaner_ids&&!!Array.isArray(a.preferred_cleaner_ids)&&0!==a.preferred_cleaner_ids.length&&a.preferred_cleaner_ids.some(a=>r(a)===s)),u=new Map;(p||[]).forEach(a=>{a.id&&u.set(a.id,a)}),t.forEach(a=>{a.id&&!u.has(a.id)&&u.set(a.id,a)});let v=Array.from(u.values()),w=e(k.created_at),x=f(v),y=g(w,x),z=h({service_type:n.service_type||"",total_amount:Number(n.total_amount)||0,service_fee:Number(n.service_fee)||0,equipment_supply_price:Number(n.equipment_supply_price)||0,additional_cleaners_price:Number(n.additional_cleaners_price)||0,preferred_cleaner_ids:n.preferred_cleaner_ids,preferred_cleaner_id:n.preferred_cleaner_id},d,y,n.preferred_cleaner_ids),A=i(Number(n.tip_amount)||0,n.preferred_cleaner_ids,n.preferred_cleaner_id);return{success:!0,earnings:{baseEarnings:z,tipAmount:A,totalEarnings:z+A,earningsPercentage:y}}}catch(a){return console.error("Error calculating booking earnings:",a),{success:!1,error:a instanceof Error?a.message:"Failed to calculate earnings"}}}async function p(a){try{let b=await m();if(!b.success||!b.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let d=b.cleaner.id,e=await (0,c.createClient)(),{data:f,error:g}=await e.from("bookings").select("*").eq("id",a).maybeSingle();if(g)return console.error("Error fetching booking:",g),{success:!1,error:"Booking not found"};if(!f)return{success:!1,error:"Booking not found"};let h=a=>a?String(a).toLowerCase().trim():"",i=h(d),j=f.preferred_cleaner_id&&h(f.preferred_cleaner_id)===i,k=!1;if(f.preferred_cleaner_ids&&Array.isArray(f.preferred_cleaner_ids)&&(k=f.preferred_cleaner_ids.some(a=>h(a)===i)),!j&&!k)return{success:!1,error:"Unauthorized: You are not assigned to this booking"};return{success:!0,booking:f}}catch(a){return console.error("Error in getCleanerBookingById:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch booking"}}}async function q(a,b){try{let d=await m();if(!d.success||!d.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let e=d.cleaner.id,f=await (0,c.createClient)(),{data:g,error:h}=await f.from("bookings").select("*").eq("id",a).maybeSingle();if(h||!g)return{success:!1,error:"Booking not found"};let i=a=>a?String(a).toLowerCase().trim():"",j=i(e),k=g.preferred_cleaner_id&&i(g.preferred_cleaner_id)===j,l=!1;if(g.preferred_cleaner_ids&&Array.isArray(g.preferred_cleaner_ids)&&(l=g.preferred_cleaner_ids.some(a=>i(a)===j)),!(k||l))return{success:!1,error:"Unauthorized: You are not assigned to this booking"};let n=g.status;if(!(({pending:["confirmed","cancelled"],confirmed:["on_my_way","cancelled"],on_my_way:["started","cancelled"],started:["completed","cancelled"],completed:[],cancelled:[]})[n]||[]).includes(b)&&b!==n)return{success:!1,error:`Invalid status transition: cannot change from ${n} to ${b}`};let{data:o,error:p}=await f.from("bookings").update({status:b,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(p)return console.error("Error updating booking status:",p),{success:!1,error:p.message};return{success:!0,booking:o}}catch(a){return console.error("Error in updateBookingStatus:",a),{success:!1,error:a instanceof Error?a.message:"Failed to update booking status"}}}async function r(a,b,d){try{let e=await m();if(!e.success||!e.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let f=e.cleaner.id,g=await (0,c.createClient)(),{data:h,error:i}=await g.from("bookings").select("*").eq("id",a).maybeSingle();if(i||!h)return{success:!1,error:"Booking not found"};let j=a=>a?String(a).toLowerCase().trim():"",k=j(f),l=h.preferred_cleaner_id&&j(h.preferred_cleaner_id)===k,n=!1;if(h.preferred_cleaner_ids&&Array.isArray(h.preferred_cleaner_ids)&&(n=h.preferred_cleaner_ids.some(a=>j(a)===k)),!(l||n))return{success:!1,error:"Unauthorized: You are not assigned to this booking"};let{data:o,error:p}=await g.from("bookings").update({expected_arrival_time:b,lateness_reason:d,updated_at:new Date().toISOString()}).eq("id",a).select().single();if(p)return console.error("Error reporting lateness:",p),{success:!1,error:p.message};return{success:!0,booking:o}}catch(a){return console.error("Error in reportLateness:",a),{success:!1,error:a instanceof Error?a.message:"Failed to report lateness"}}}async function s(a){try{let b=await m();if(!b.success||!b.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let d=b.cleaner.id,j=await (0,c.createClient)();if(0===a.length)return{success:!0,earnings:{}};let{data:k,error:l}=await j.from("cleaners").select("created_at").eq("id",d).maybeSingle();if(l||!k)return{success:!1,error:"Cleaner not found"};let{data:n,error:o}=await j.from("bookings").select("*").in("id",a);if(o||!n)return{success:!1,error:"Failed to fetch bookings"};let{data:p}=await j.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").eq("preferred_cleaner_id",d),{data:q}=await j.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").not("preferred_cleaner_ids","is",null),r=a=>a?String(a).toLowerCase().trim():"",s=r(d),t=(q||[]).filter(a=>!!a.preferred_cleaner_ids&&!!Array.isArray(a.preferred_cleaner_ids)&&0!==a.preferred_cleaner_ids.length&&a.preferred_cleaner_ids.some(a=>r(a)===s)),u=new Map;(p||[]).forEach(a=>{a.id&&u.set(a.id,a)}),t.forEach(a=>{a.id&&!u.has(a.id)&&u.set(a.id,a)});let v=Array.from(u.values()),w=e(k.created_at),x=f(v),y=g(w,x),z={};for(let a of n){let b=h({service_type:a.service_type||"",total_amount:Number(a.total_amount)||0,service_fee:Number(a.service_fee)||0,equipment_supply_price:Number(a.equipment_supply_price)||0,additional_cleaners_price:Number(a.additional_cleaners_price)||0,preferred_cleaner_ids:a.preferred_cleaner_ids,preferred_cleaner_id:a.preferred_cleaner_id},d,y,a.preferred_cleaner_ids),c=i(Number(a.tip_amount)||0,a.preferred_cleaner_ids,a.preferred_cleaner_id);z[a.id]={baseEarnings:b,tipAmount:c,totalEarnings:b+c}}return{success:!0,earnings:z}}catch(a){return console.error("Error calculating bookings earnings:",a),{success:!1,error:a instanceof Error?a.message:"Failed to calculate earnings"}}}async function t(){try{let a=await m();if(!a.success||!a.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let b=a.cleaner.id,d=await (0,c.createClient)(),{data:h,error:i}=await d.from("cleaners").select("rating, reliability_score, total_bookings, completed_bookings, on_time_bookings, created_at").eq("id",b).maybeSingle();if(i||!h)return{success:!1,error:"Cleaner not found"};let{data:k,error:l}=await d.from("bookings").select("id, status, service_date, total_amount, payment_status, service_type, service_fee, subtotal, tip_amount, service_duration, equipment_supply_price, additional_cleaners_price, preferred_cleaner_id, preferred_cleaner_ids").eq("preferred_cleaner_id",b),{data:n,error:o}=await d.from("bookings").select("id, status, service_date, total_amount, payment_status, service_type, service_fee, subtotal, tip_amount, service_duration, equipment_supply_price, additional_cleaners_price, preferred_cleaner_ids, preferred_cleaner_id").not("preferred_cleaner_ids","is",null);if(l||o)return console.error("Error fetching bookings for stats:",l||o),{success:!1,error:(l||o)?.message||"Failed to fetch bookings"};console.log("[getCleanerStats] Fetched bookings:",{cleanerId:b,singleBookingsCount:k?.length||0,allMultiBookingsCount:n?.length||0});let p=a=>a?String(a).toLowerCase().trim():"",q=p(b),r=(n||[]).filter(a=>!!a.preferred_cleaner_ids&&!!Array.isArray(a.preferred_cleaner_ids)&&0!==a.preferred_cleaner_ids.length&&a.preferred_cleaner_ids.some(a=>p(a)===q)),s=new Map;(k||[]).forEach(a=>{a.id&&s.set(a.id,a)}),r.forEach(a=>{a.id&&!s.has(a.id)&&s.set(a.id,a)});let t=Array.from(s.values()),u=new Date().toISOString().split("T")[0],v=new Date,w=new Date(v.getFullYear(),v.getMonth(),1).toISOString().split("T")[0],x=t.filter(a=>"completed"===a.status),y=t.filter(a=>["pending","confirmed","on_my_way","started"].includes(a.status)&&a.service_date>=u),z=t.filter(a=>a.service_date===u);t.filter(a=>"paid"===a.payment_status);let A=t.filter(a=>"completed"===a.status&&"paid"===a.payment_status&&a.service_date>=w),B=t.filter(a=>"completed"===a.status&&"paid"===a.payment_status),C=e(h.created_at),D=f(t),E=g(C,D),F=B.reduce((a,c)=>{let d=j({service_type:c.service_type||"",total_amount:Number(c.total_amount)||0,service_fee:Number(c.service_fee)||0,equipment_supply_price:Number(c.equipment_supply_price)||0,additional_cleaners_price:Number(c.additional_cleaners_price)||0,tip_amount:Number(c.tip_amount)||0,preferred_cleaner_ids:c.preferred_cleaner_ids,preferred_cleaner_id:c.preferred_cleaner_id},b,E);return a+d},0),G=A.reduce((a,c)=>{let d=j({service_type:c.service_type||"",total_amount:Number(c.total_amount)||0,service_fee:Number(c.service_fee)||0,equipment_supply_price:Number(c.equipment_supply_price)||0,additional_cleaners_price:Number(c.additional_cleaners_price)||0,tip_amount:Number(c.tip_amount)||0,preferred_cleaner_ids:c.preferred_cleaner_ids,preferred_cleaner_id:c.preferred_cleaner_id},b,E);return a+d},0),H=h.total_bookings?(h.completed_bookings||0)/h.total_bookings*100:0,I=h.completed_bookings?(h.on_time_bookings||0)/h.completed_bookings*100:0;return{success:!0,stats:{totalBookings:t.length,completedBookings:x.length,upcomingBookings:y.length,todayBookings:z.length,totalEarnings:F,monthlyEarnings:G,averageRating:Number(h.rating)||0,reliabilityScore:Number(h.reliability_score)||0,completionRate:H,onTimeRate:I}}}catch(a){return console.error("Error in getCleanerStats:",a),{success:!1,error:a instanceof Error?a.message:"Failed to fetch stats"}}}async function u(a,b){try{let d=await (0,c.createClient)(),e={updated_at:new Date().toISOString()};void 0!==b.isAvailable&&(e.is_available=b.isAvailable),void 0!==b.availableMonday&&(e.available_monday=b.availableMonday),void 0!==b.availableTuesday&&(e.available_tuesday=b.availableTuesday),void 0!==b.availableWednesday&&(e.available_wednesday=b.availableWednesday),void 0!==b.availableThursday&&(e.available_thursday=b.availableThursday),void 0!==b.availableFriday&&(e.available_friday=b.availableFriday),void 0!==b.availableSaturday&&(e.available_saturday=b.availableSaturday),void 0!==b.availableSunday&&(e.available_sunday=b.availableSunday);let{data:f,error:g}=await d.from("cleaners").update(e).eq("id",a).select().single();if(g)return console.error("Error updating cleaner availability:",g),{success:!1,error:g.message};return{success:!0,cleaner:f}}catch(a){return console.error("Error in updateCleanerAvailability:",a),{success:!1,error:a instanceof Error?a.message:"Failed to update availability"}}}(0,a.i(13095).ensureServerEntryExports)([k,l,m,n,o,p,q,r,s,t,u]),(0,b.registerServerReference)(k,"40a59651451de26f1e1318bdf061853f29caa0cb96",null),(0,b.registerServerReference)(l,"6043abd4f96c9644075ceca5fb9c27d4de151dc1de",null),(0,b.registerServerReference)(m,"0008ec0d16c34a0c3446af64c83f7600e71361b2d2",null),(0,b.registerServerReference)(n,"4010dfc5e7290ed566ac5451a825670e6b0a87a856",null),(0,b.registerServerReference)(o,"40644369c6d186ff3b456047295632caa4127d9b75",null),(0,b.registerServerReference)(p,"40b70fadc2d78351c0aaaa94538181d6f99823f978",null),(0,b.registerServerReference)(q,"6064d8a430608f311b64c7540b59c0c636ec49f7cc",null),(0,b.registerServerReference)(r,"70161269115dbe51e4a180874d06645c18c4fdb06f",null),(0,b.registerServerReference)(s,"40e353ec89965e9b4f7860098ee24cb05823cbac4e",null),(0,b.registerServerReference)(t,"0009e7b688087b33395d531c8fc22ba085a5ee9838",null),(0,b.registerServerReference)(u,"60590337447e35286ff3fd13afb4f2478fad04933e",null),a.s(["authenticateCleaner",()=>l,"calculateBookingEarnings",()=>o,"calculateBookingsEarnings",()=>s,"getCleanerBookingById",()=>p,"getCleanerBookings",()=>n,"getCleanerByPhone",()=>k,"getCleanerStats",()=>t,"getCurrentCleaner",()=>m,"reportLateness",()=>r,"updateBookingStatus",()=>q,"updateCleanerAvailability",()=>u],5293)}];

//# sourceMappingURL=app_cleaner_actions_ts_03142651._.js.map