module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},42315,(e,t,r)=>{"use strict";t.exports=e.r(18622)},47540,(e,t,r)=>{"use strict";t.exports=e.r(42315).vendored["react-rsc"].React},33086,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),n=e.i(59756),s=e.i(61916),o=e.i(74677),i=e.i(69741),d=e.i(16795),l=e.i(87718),u=e.i(95169),c=e.i(47587),p=e.i(66012),f=e.i(70101),m=e.i(26937),g=e.i(10372),h=e.i(93695);e.i(52474);var x=e.i(5232),b=e.i(89171),R=e.i(26500);async function _(e){try{let t=await (0,R.createClient)(),{data:{user:r},error:a}=await t.auth.getUser();if(a||!r)return b.NextResponse.json({error:"Unauthorized"},{status:401});let n=r.email;if(!n)return b.NextResponse.json({error:"User email not found"},{status:400});let{bookingIds:s,creditsAmount:o}=await e.json();if(!s||!Array.isArray(s)||0===s.length)return b.NextResponse.json({error:"Booking IDs are required"},{status:400});if(!o||o<=0)return b.NextResponse.json({error:"Credit amount must be greater than 0"},{status:400});let{data:i,error:d}=await t.from("profiles").select("id, credit_balance").eq("email",n).maybeSingle();if(d)return console.error("Error fetching profile:",d),b.NextResponse.json({error:"Failed to fetch profile"},{status:500});if(!i){let{data:e,error:a}=await t.from("profiles").insert({email:n,credit_balance:0,first_name:r.user_metadata?.first_name||"",last_name:r.user_metadata?.last_name||""}).select("id, credit_balance").single();if(a||!e)return console.error("Error creating profile:",a),b.NextResponse.json({error:"Failed to create profile",details:a?.message},{status:500});i=e}let l=i.credit_balance||0;if(l<o)return b.NextResponse.json({error:"Insufficient ShaleanCred balance",currentBalance:l,requestedAmount:o},{status:400});let{data:u,error:c}=await t.from("bookings").select("id, total_amount, tip_amount, credits_used, subtotal, service_fee").in("id",s);if(c||!u||0===u.length)return b.NextResponse.json({error:"Bookings not found"},{status:404});let p=u.reduce((e,t)=>{let r=Number(t.total_amount)||0,a=Number(t.tip_amount)||0,n=Number(t.subtotal||0)+Number(t.service_fee||0);return a>0&&.01>Math.abs(r-n)?e+r+a:e+r},0),f=Math.round(100*o)/100,m=Math.round(100*p)/100,g=Math.min(f,m);if(f>m+.01)return b.NextResponse.json({error:"Credit amount exceeds booking total",bookingTotal:m,requestedAmount:f,message:`You can use up to R${m.toFixed(2)} in credits for this booking.`},{status:400});let h=u.reduce((e,t)=>e+(Number(t.credits_used)||0),0);if(h>0)return b.NextResponse.json({error:"Credits have already been used for these bookings",alreadyUsed:h},{status:400});let x=l-g,{error:_}=await t.from("profiles").update({credit_balance:x,updated_at:new Date().toISOString()}).eq("id",i.id);if(_)return console.error("Error updating credit balance:",_),b.NextResponse.json({error:"Failed to update credit balance",details:_.message},{status:500});let w=Math.round(100*g)/100,v=[];for(let e of u){if(w<=.01)break;let t=Number(e.total_amount)||0,r=Number(e.tip_amount)||0,a=Number(e.subtotal||0)+Number(e.service_fee||0),n=r>0&&.01>Math.abs(t-a)?t+r:t,s=Math.round(100*n)/100,o=Math.min(w,s),i=Math.round(100*o)/100;v.push({id:e.id,credits_used:i}),w=Math.round((w-i)*100)/100}for(let e of v){let{error:r}=await t.from("bookings").update({credits_used:e.credits_used,amount_paid:e.credits_used,updated_at:new Date().toISOString()}).eq("id",e.id);if(r)return console.error(`Error updating booking ${e.id}:`,r),await t.from("profiles").update({credit_balance:l,updated_at:new Date().toISOString()}).eq("id",i.id),b.NextResponse.json({error:"Failed to update booking with credits",details:r.message},{status:500})}let{data:E,error:N}=await t.from("credit_transactions").insert({profile_id:i.id,email:n,transaction_type:"usage",amount:-g,balance_before:l,balance_after:x,payment_status:"completed",booking_id:u[0].id,description:`Used R${g.toFixed(2)} ShaleanCred for booking(s)`,metadata:{booking_ids:s,credits_distribution:v.map(e=>({booking_id:e.id,credits:e.credits_used}))}}).select("id").single();if(N){for(let e of(console.error("Error creating credit transaction:",N),await t.from("profiles").update({credit_balance:l,updated_at:new Date().toISOString()}).eq("id",i.id),v))await t.from("bookings").update({credits_used:0,amount_paid:0,updated_at:new Date().toISOString()}).eq("id",e.id);return b.NextResponse.json({error:"Failed to create credit transaction",details:N.message},{status:500})}return b.NextResponse.json({success:!0,creditsUsed:g,balanceBefore:l,balanceAfter:x,transactionId:E.id,bookingUpdates:v.map(e=>({bookingId:e.id,creditsUsed:e.credits_used}))})}catch(e){return console.error("Error in use-credits API:",e),b.NextResponse.json({error:"Failed to use credits",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>_],42665);var w=e.i(42665);let v=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/bookings/use-credits/route",pathname:"/api/bookings/use-credits",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/bookings/use-credits/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:E,workUnitAsyncStorage:N,serverHooks:k}=v;function y(){return(0,a.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:N})}async function C(e,t,a){v.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/bookings/use-credits/route";b=b.replace(/\/index$/,"")||"/";let R=await v.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:_,params:w,nextConfig:E,parsedUrl:N,isDraftMode:k,prerenderManifest:y,routerServerContext:C,isOnDemandRevalidate:A,revalidateOnlyGenerated:j,resolvedPathname:S,clientReferenceManifest:q,serverActionsManifest:O}=R,T=(0,i.normalizeAppPath)(b),I=!!(y.dynamicRoutes[T]||y.routes[S]),P=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,N,!1):t.end("This page could not be found"),null);if(I&&!k){let e=!!y.routes[S],t=y.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await P();throw new h.NoFallbackError}}let U=null;!I||v.isDev||k||(U="/index"===(U=S)?"/":U);let M=!0===v.isDev||!I,D=I&&!M;O&&q&&(0,o.setManifestsSingleton)({page:b,clientReferenceManifest:q,serverActionsManifest:O});let H=e.method||"GET",F=(0,s.getTracer)(),$=F.getActiveScopeSpan(),B={params:w,prerenderManifest:y,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>v.onRequestError(e,t,a,n,C)},sharedContext:{buildId:_}},K=new d.NodeNextRequest(e),L=new d.NodeNextResponse(t),G=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(t));try{let o=async e=>v.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${b}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var s,d;let l=async({previousCacheEntry:r})=>{try{if(!i&&A&&j&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let d=B.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=B.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)(K,L,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:A})},!1,C),t}},u=await v.handleResponse({req:e,nextConfig:E,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:j,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:i});if(!I)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",A?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&I||h.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(K,L,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};$?await d($):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${b}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof h.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:A})},!1,C),I)throw t;return await (0,p.sendResponse)(K,L,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>y,"routeModule",()=>v,"serverHooks",()=>k,"workAsyncStorage",()=>E,"workUnitAsyncStorage",()=>N],33086)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__f2e5ff35._.js.map