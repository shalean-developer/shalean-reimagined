{"version":3,"sources":["../../../src/lib/paystack/client.ts"],"sourcesContent":["/**\r\n * Paystack API client\r\n */\r\n\r\nconst PAYSTACK_SECRET_KEY = process.env.PAYSTACK_SECRET_KEY;\r\nconst PAYSTACK_PUBLIC_KEY = process.env.NEXT_PUBLIC_PAYSTACK_PUBLIC_KEY;\r\nconst PAYSTACK_API_URL = 'https://api.paystack.co';\r\n\r\nexport interface PaystackInitializeResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: {\r\n    authorization_url: string;\r\n    access_code: string;\r\n    reference: string;\r\n  };\r\n}\r\n\r\nexport interface PaystackVerifyResponse {\r\n  status: boolean;\r\n  message: string;\r\n  data: {\r\n    id: number;\r\n    domain: string;\r\n    status: string;\r\n    reference: string;\r\n    amount: number;\r\n    message: string | null;\r\n    gateway_response: string;\r\n    paid_at: string | null;\r\n    created_at: string;\r\n    channel: string;\r\n    currency: string;\r\n    ip_address: string;\r\n    metadata: {\r\n      booking_id?: string;\r\n      customer_email?: string;\r\n      custom_fields?: Array<{ display_name: string; variable_name: string; value: string }>;\r\n    };\r\n    log: any;\r\n    fees: number;\r\n    fees_split: any;\r\n    authorization: any;\r\n    customer: any;\r\n    plan: any;\r\n    split: any;\r\n    order_id: any;\r\n    paidAt: string | null;\r\n    createdAt: string;\r\n    requested_amount: number;\r\n    pos_transaction_data: any;\r\n    source: any;\r\n    fees_breakdown: any;\r\n  };\r\n}\r\n\r\n/**\r\n * Initialize a Paystack transaction\r\n */\r\nexport async function initializePayment(\r\n  email: string,\r\n  amount: number, // Amount in kobo (Nigerian Naira) or cents. For ZAR, convert to cents (amount * 100)\r\n  reference: string,\r\n  metadata?: {\r\n    booking_id?: string;\r\n    [key: string]: any;\r\n  }\r\n): Promise<PaystackInitializeResponse> {\r\n  if (!PAYSTACK_SECRET_KEY) {\r\n    throw new Error('Paystack secret key is not configured');\r\n  }\r\n\r\n  // Convert ZAR amount to kobo/cents (multiply by 100)\r\n  const amountInKobo = Math.round(amount * 100);\r\n\r\n  // Build callback URL for payment success page\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';\r\n  const callbackUrl = `${appUrl}/payment/success?reference=${reference}`;\r\n\r\n  const response = await fetch(`${PAYSTACK_API_URL}/transaction/initialize`, {\r\n    method: 'POST',\r\n    headers: {\r\n      'Authorization': `Bearer ${PAYSTACK_SECRET_KEY}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n    body: JSON.stringify({\r\n      email,\r\n      amount: amountInKobo,\r\n      reference,\r\n      metadata,\r\n      currency: 'ZAR', // South African Rand\r\n      callback_url: callbackUrl,\r\n    }),\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const error = await response.json();\r\n    throw new Error(error.message || 'Failed to initialize payment');\r\n  }\r\n\r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Verify a Paystack transaction\r\n */\r\nexport async function verifyPayment(reference: string): Promise<PaystackVerifyResponse> {\r\n  if (!PAYSTACK_SECRET_KEY) {\r\n    throw new Error('Paystack secret key is not configured');\r\n  }\r\n\r\n  const response = await fetch(`${PAYSTACK_API_URL}/transaction/verify/${reference}`, {\r\n    method: 'GET',\r\n    headers: {\r\n      'Authorization': `Bearer ${PAYSTACK_SECRET_KEY}`,\r\n      'Content-Type': 'application/json',\r\n    },\r\n  });\r\n\r\n  if (!response.ok) {\r\n    const error = await response.json();\r\n    throw new Error(error.message || 'Failed to verify payment');\r\n  }\r\n\r\n  return response.json();\r\n}\r\n\r\n/**\r\n * Verify Paystack webhook signature\r\n */\r\nexport function verifyWebhookSignature(\r\n  payload: string,\r\n  signature: string\r\n): boolean {\r\n  const crypto = require('crypto');\r\n  const secret = process.env.PAYSTACK_WEBHOOK_SECRET || PAYSTACK_SECRET_KEY || '';\r\n  \r\n  if (!secret) {\r\n    return false;\r\n  }\r\n\r\n  const hash = crypto\r\n    .createHmac('sha512', secret)\r\n    .update(payload)\r\n    .digest('hex');\r\n\r\n  return hash === signature;\r\n}\r\n\r\n/**\r\n * Get Paystack public key for client-side use\r\n */\r\nexport function getPaystackPublicKey(): string {\r\n  if (!PAYSTACK_PUBLIC_KEY) {\r\n    throw new Error('Paystack public key is not configured');\r\n  }\r\n  return PAYSTACK_PUBLIC_KEY;\r\n}\r\n\r\n"],"names":[],"mappings":"sGAIA,IAAM,EAAsB,QAAQ,GAAG,CAAC,mBAAmB,CAErD,EAAmB,0BAqDlB,eAAe,EACpB,CAAa,CACb,CAAc,CACd,CAAiB,CACjB,CAGC,EAED,GAAI,CAAC,EACH,MAAM,AAAI,MAAM,OADQ,kCAK1B,IAAM,EAAe,KAAK,KAAK,CAAU,IAAT,GAI1B,EAAc,GAAG,OAAO,2BAA2B,cAAE,GAAW,CAEhE,EAAW,MAAM,MAAM,CAAA,EAAG,EAAiB,uBAAuB,CAAC,CAAE,CACzE,OAAQ,OACR,QAAS,CACP,cAAiB,CAAC,OAAO,EAAE,EAAA,CAAqB,CAChD,eAAgB,kBAClB,EACA,KAAM,KAAK,SAAS,CAAC,OACnB,EACA,OAAQ,YACR,WACA,EACA,SAAU,MACV,aAAc,CAChB,EACF,GAEA,GAAI,CAAC,EAAS,EAAE,CAEd,CAFgB,KAEV,AAAI,MAAM,CADF,MAAM,EAAS,IAAI,EAAA,EACX,OAAO,EAAI,gCAGnC,OAAO,EAAS,IAAI,EACtB,CAKO,eAAe,EAAc,CAAiB,EACnD,GAAI,CAAC,EACH,MAAM,AAAI,MAAM,OADQ,kCAI1B,IAAM,EAAW,MAAM,MAAM,CAAA,EAAG,EAAiB,oBAAoB,EAAE,EAAA,CAAW,CAAE,CAClF,OAAQ,MACR,QAAS,CACP,cAAiB,CAAC,OAAO,EAAE,EAAA,CAAqB,CAChD,eAAgB,kBAClB,CACF,GAEA,GAAI,CAAC,EAAS,EAAE,CAEd,CAFgB,KAEV,AAAI,MAAM,CADF,MAAM,EAAS,IAAI,EAAA,EACX,OAAO,EAAI,4BAGnC,OAAO,EAAS,IAAI,EACtB,CAKO,SAAS,EACd,CAAe,CACf,CAAiB,EAEjB,IAAM,EAAA,EAAA,CAAA,CAAA,OACA,EAAS,QAAQ,GAAG,CAAC,uBAAuB,EAAI,GAAuB,SAE7E,CAAI,CAAC,GAIQ,AAKN,EAJJ,GALU,OAKA,CAAC,SAAU,GACrB,MAAM,CAAC,GACP,MAAM,CAAC,SAEM,CAClB,CAKO,SAAS,IAId,MAvJI,CAuJG,iDACT"}