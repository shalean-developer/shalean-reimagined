module.exports=[8214,e=>{"use strict";var r=e.i(45015),a=e.i(26500),t=e.i(67543);function n(e){if(!e)return 0;let r="string"==typeof e?new Date(e):e;return Math.max(0,(new Date().getTime()-r.getTime())/864e5/30)}function s(e){return e&&0!==e.length?e.filter(e=>"completed"===e.status&&"paid"===e.payment_status).reduce((e,r)=>e+(Number(r.service_duration)||0),0):0}function i(e,r){return e>=3&&r>=400?.7:.6}function o(e,r,a,t){if(function(e){if(!e)return!1;let r=e.toLowerCase().trim();return!!(r.includes("deep")||r.includes("move")&&(r.includes("in/out")||r.includes("in out")||r.includes("inout"))||r.includes("carpet"))}(e.service_type))return 250;let n=Number(e.equipment_supply_price)||0,s=Number(e.additional_cleaners_price)||0,i=(Number(e.total_amount)||0)-(Number(e.service_fee)||0)-n,o=1;return t&&Array.isArray(t)&&t.length>0?o=t.length:e.preferred_cleaner_ids&&Array.isArray(e.preferred_cleaner_ids)&&e.preferred_cleaner_ids.length>0?o=e.preferred_cleaner_ids.length:e.preferred_cleaner_id&&(o=1),(i*a+s)/o}function c(e,r,a){let t=Number(e)||0;if(t<=0)return 0;let n=1;return r&&Array.isArray(r)&&r.length>0?n=r.length:a&&(n=1),t/n}function l(e,r,a){return o(e,r,a,e.preferred_cleaner_ids||null)+c(e.tip_amount||0,e.preferred_cleaner_ids,e.preferred_cleaner_id)}async function d(e){try{let r=await (0,a.createClient)(),t=e.replace(/\s+/g,"").trim(),{data:n,error:s}=await r.from("cleaners").select("*").or(`phone.eq.${t},phone.eq.+${t}`).eq("is_active",!0).maybeSingle();if(s)return console.error("Error fetching cleaner by phone:",s),{success:!1,error:s.message};if(!n)return{success:!1,error:"Cleaner not found"};return{success:!0,cleaner:n}}catch(e){return console.error("Error in getCleanerByPhone:",e),{success:!1,error:e instanceof Error?e.message:"Failed to fetch cleaner"}}}async function u(e,r){try{let n=await d(e);if(!n.success||!n.cleaner)return{success:!1,error:"Invalid phone number or password"};let s=n.cleaner,i=e.replace(/\s+/g,"").trim(),o=`${i}@cleaners.shalean.local`,c=await (0,a.createClient)(),{data:l,error:u}=await c.auth.signInWithPassword({email:o,password:r});if(u)return console.error("Authentication error:",u),{success:!1,error:"Invalid phone number or password"};if(!l.user)return{success:!1,error:"Authentication failed"};if(!s.auth_user_id)try{let e=(0,t.createAdminClient)();await e.from("cleaners").update({auth_user_id:l.user.id}).eq("id",s.id)}catch(e){console.warn("Could not update auth_user_id:",e)}return{success:!0,cleaner:s}}catch(e){return console.error("Error in authenticateCleaner:",e),{success:!1,error:e instanceof Error?e.message:"Authentication failed"}}}async function _(){try{let e=await (0,a.createClient)(),{data:{user:r},error:t}=await e.auth.getUser();if(t||!r)return{success:!1,error:"Not authenticated"};let n=e.from("cleaners").select("*").eq("auth_user_id",r.id).eq("is_active",!0).maybeSingle(),{data:s,error:i}=await n;if(!s&&!i&&r.email){let e=r.email.match(/^(.+)@cleaners\.shalean\.local$/);if(e){let r=e[1],a=await d(r);a.success&&a.cleaner&&(s=a.cleaner)}}if(i||!s)return{success:!1,error:"Cleaner profile not found"};return{success:!0,cleaner:s}}catch(e){return console.error("Error in getCurrentCleaner:",e),{success:!1,error:e instanceof Error?e.message:"Failed to get cleaner"}}}async function f(e){try{let r=await _();if(!r.success||!r.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let t=r.cleaner.id,n=await (0,a.createClient)(),s=n.from("bookings").select("*").eq("preferred_cleaner_id",t),i=n.from("bookings").select("*").not("preferred_cleaner_ids","is",null);if(e&&"all"!==e){let r=new Date().toISOString().split("T")[0];switch(e){case"today":s=s.eq("service_date",r),i=i.eq("service_date",r);break;case"upcoming":s=s.gte("service_date",r).in("status",["pending","confirmed","on_my_way","started"]),i=i.gte("service_date",r).in("status",["pending","confirmed","on_my_way","started"]);break;case"past":s=s.lt("service_date",r).or("status.eq.completed,status.eq.cancelled"),i=i.lt("service_date",r).or("status.eq.completed,status.eq.cancelled");break;case"on_my_way":s=s.eq("status","on_my_way"),i=i.eq("status","on_my_way");break;case"started":s=s.eq("status","started"),i=i.eq("status","started")}}let[o,c]=await Promise.all([s.order("service_date",{ascending:!0}).order("service_time",{ascending:!0}),i.order("service_date",{ascending:!0}).order("service_time",{ascending:!0})]);if(o.error)return console.error("Error fetching cleaner bookings (single):",o.error),{success:!1,error:o.error.message};if(c.error)return console.error("Error fetching cleaner bookings (array):",c.error),{success:!1,error:c.error.message};console.log("[getCleanerBookings] Fetched bookings:",{cleanerId:t,filter:e,singleBookingsCount:o.data?.length||0,arrayBookingsCount:c.data?.length||0});let l=e=>e?String(e).toLowerCase().trim():"",d=l(t),u=(c.data||[]).filter(e=>!!e.preferred_cleaner_ids&&!!Array.isArray(e.preferred_cleaner_ids)&&0!==e.preferred_cleaner_ids.length&&e.preferred_cleaner_ids.some(e=>l(e)===d)),f=[...o.data||[],...u],p=new Map;f.forEach(e=>{e.id&&!p.has(e.id)&&p.set(e.id,e)});let g=Array.from(p.values());return g.sort((e,r)=>{let a=e.service_date.localeCompare(r.service_date);return 0!==a?a:e.service_time.localeCompare(r.service_time)}),{success:!0,bookings:g}}catch(e){return console.error("Error in getCleanerBookings:",e),{success:!1,error:e instanceof Error?e.message:"Failed to fetch bookings"}}}async function p(e){try{let r=await _();if(!r.success||!r.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let t=r.cleaner.id,l=await (0,a.createClient)(),{data:d,error:u}=await l.from("cleaners").select("created_at").eq("id",t).maybeSingle();if(u||!d)return{success:!1,error:"Cleaner not found"};let{data:f,error:p}=await l.from("bookings").select("*").eq("id",e).maybeSingle();if(p||!f)return{success:!1,error:"Booking not found"};let{data:g}=await l.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").eq("preferred_cleaner_id",t),{data:m}=await l.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").not("preferred_cleaner_ids","is",null),b=e=>e?String(e).toLowerCase().trim():"",y=b(t),v=(m||[]).filter(e=>!!e.preferred_cleaner_ids&&!!Array.isArray(e.preferred_cleaner_ids)&&0!==e.preferred_cleaner_ids.length&&e.preferred_cleaner_ids.some(e=>b(e)===y)),h=new Map;(g||[]).forEach(e=>{e.id&&h.set(e.id,e)}),v.forEach(e=>{e.id&&!h.has(e.id)&&h.set(e.id,e)});let w=Array.from(h.values()),k=n(d.created_at),S=s(w),C=i(k,S),E=o({service_type:f.service_type||"",total_amount:Number(f.total_amount)||0,service_fee:Number(f.service_fee)||0,equipment_supply_price:Number(f.equipment_supply_price)||0,additional_cleaners_price:Number(f.additional_cleaners_price)||0,preferred_cleaner_ids:f.preferred_cleaner_ids,preferred_cleaner_id:f.preferred_cleaner_id},t,C,f.preferred_cleaner_ids),q=c(Number(f.tip_amount)||0,f.preferred_cleaner_ids,f.preferred_cleaner_id);return{success:!0,earnings:{baseEarnings:E,tipAmount:q,totalEarnings:E+q,earningsPercentage:C}}}catch(e){return console.error("Error calculating booking earnings:",e),{success:!1,error:e instanceof Error?e.message:"Failed to calculate earnings"}}}async function g(e){try{let r=await _();if(!r.success||!r.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let t=r.cleaner.id,n=await (0,a.createClient)(),{data:s,error:i}=await n.from("bookings").select("*").eq("id",e).maybeSingle();if(i)return console.error("Error fetching booking:",i),{success:!1,error:"Booking not found"};if(!s)return{success:!1,error:"Booking not found"};let o=e=>e?String(e).toLowerCase().trim():"",c=o(t),l=s.preferred_cleaner_id&&o(s.preferred_cleaner_id)===c,d=!1;if(s.preferred_cleaner_ids&&Array.isArray(s.preferred_cleaner_ids)&&(d=s.preferred_cleaner_ids.some(e=>o(e)===c)),!l&&!d)return{success:!1,error:"Unauthorized: You are not assigned to this booking"};return{success:!0,booking:s}}catch(e){return console.error("Error in getCleanerBookingById:",e),{success:!1,error:e instanceof Error?e.message:"Failed to fetch booking"}}}async function m(e,r){try{let t=await _();if(!t.success||!t.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let n=t.cleaner.id,s=await (0,a.createClient)(),{data:i,error:o}=await s.from("bookings").select("*").eq("id",e).maybeSingle();if(o||!i)return{success:!1,error:"Booking not found"};let c=e=>e?String(e).toLowerCase().trim():"",l=c(n),d=i.preferred_cleaner_id&&c(i.preferred_cleaner_id)===l,u=!1;if(i.preferred_cleaner_ids&&Array.isArray(i.preferred_cleaner_ids)&&(u=i.preferred_cleaner_ids.some(e=>c(e)===l)),!(d||u))return{success:!1,error:"Unauthorized: You are not assigned to this booking"};let f=i.status;if(!(({pending:["confirmed","cancelled"],confirmed:["on_my_way","cancelled"],on_my_way:["started","cancelled"],started:["completed","cancelled"],completed:[],cancelled:[]})[f]||[]).includes(r)&&r!==f)return{success:!1,error:`Invalid status transition: cannot change from ${f} to ${r}`};let{data:p,error:g}=await s.from("bookings").update({status:r,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(g)return console.error("Error updating booking status:",g),{success:!1,error:g.message};return{success:!0,booking:p}}catch(e){return console.error("Error in updateBookingStatus:",e),{success:!1,error:e instanceof Error?e.message:"Failed to update booking status"}}}async function b(e,r,t){try{let n=await _();if(!n.success||!n.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let s=n.cleaner.id,i=await (0,a.createClient)(),{data:o,error:c}=await i.from("bookings").select("*").eq("id",e).maybeSingle();if(c||!o)return{success:!1,error:"Booking not found"};let l=e=>e?String(e).toLowerCase().trim():"",d=l(s),u=o.preferred_cleaner_id&&l(o.preferred_cleaner_id)===d,f=!1;if(o.preferred_cleaner_ids&&Array.isArray(o.preferred_cleaner_ids)&&(f=o.preferred_cleaner_ids.some(e=>l(e)===d)),!(u||f))return{success:!1,error:"Unauthorized: You are not assigned to this booking"};let{data:p,error:g}=await i.from("bookings").update({expected_arrival_time:r,lateness_reason:t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(g)return console.error("Error reporting lateness:",g),{success:!1,error:g.message};return{success:!0,booking:p}}catch(e){return console.error("Error in reportLateness:",e),{success:!1,error:e instanceof Error?e.message:"Failed to report lateness"}}}async function y(e){try{let r=await _();if(!r.success||!r.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let t=r.cleaner.id,l=await (0,a.createClient)();if(0===e.length)return{success:!0,earnings:{}};let{data:d,error:u}=await l.from("cleaners").select("created_at").eq("id",t).maybeSingle();if(u||!d)return{success:!1,error:"Cleaner not found"};let{data:f,error:p}=await l.from("bookings").select("*").in("id",e);if(p||!f)return{success:!1,error:"Failed to fetch bookings"};let{data:g}=await l.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").eq("preferred_cleaner_id",t),{data:m}=await l.from("bookings").select("status, payment_status, service_duration, preferred_cleaner_id, preferred_cleaner_ids").not("preferred_cleaner_ids","is",null),b=e=>e?String(e).toLowerCase().trim():"",y=b(t),v=(m||[]).filter(e=>!!e.preferred_cleaner_ids&&!!Array.isArray(e.preferred_cleaner_ids)&&0!==e.preferred_cleaner_ids.length&&e.preferred_cleaner_ids.some(e=>b(e)===y)),h=new Map;(g||[]).forEach(e=>{e.id&&h.set(e.id,e)}),v.forEach(e=>{e.id&&!h.has(e.id)&&h.set(e.id,e)});let w=Array.from(h.values()),k=n(d.created_at),S=s(w),C=i(k,S),E={};for(let e of f){let r=o({service_type:e.service_type||"",total_amount:Number(e.total_amount)||0,service_fee:Number(e.service_fee)||0,equipment_supply_price:Number(e.equipment_supply_price)||0,additional_cleaners_price:Number(e.additional_cleaners_price)||0,preferred_cleaner_ids:e.preferred_cleaner_ids,preferred_cleaner_id:e.preferred_cleaner_id},t,C,e.preferred_cleaner_ids),a=c(Number(e.tip_amount)||0,e.preferred_cleaner_ids,e.preferred_cleaner_id);E[e.id]={baseEarnings:r,tipAmount:a,totalEarnings:r+a}}return{success:!0,earnings:E}}catch(e){return console.error("Error calculating bookings earnings:",e),{success:!1,error:e instanceof Error?e.message:"Failed to calculate earnings"}}}async function v(){try{let e=await _();if(!e.success||!e.cleaner)return{success:!1,error:"Not authenticated or cleaner profile not found"};let r=e.cleaner.id,t=await (0,a.createClient)(),{data:o,error:c}=await t.from("cleaners").select("rating, reliability_score, total_bookings, completed_bookings, on_time_bookings, created_at").eq("id",r).maybeSingle();if(c||!o)return{success:!1,error:"Cleaner not found"};let{data:d,error:u}=await t.from("bookings").select("id, status, service_date, total_amount, payment_status, service_type, service_fee, subtotal, tip_amount, service_duration, equipment_supply_price, additional_cleaners_price, preferred_cleaner_id, preferred_cleaner_ids").eq("preferred_cleaner_id",r),{data:f,error:p}=await t.from("bookings").select("id, status, service_date, total_amount, payment_status, service_type, service_fee, subtotal, tip_amount, service_duration, equipment_supply_price, additional_cleaners_price, preferred_cleaner_ids, preferred_cleaner_id").not("preferred_cleaner_ids","is",null);if(u||p)return console.error("Error fetching bookings for stats:",u||p),{success:!1,error:(u||p)?.message||"Failed to fetch bookings"};console.log("[getCleanerStats] Fetched bookings:",{cleanerId:r,singleBookingsCount:d?.length||0,allMultiBookingsCount:f?.length||0});let g=e=>e?String(e).toLowerCase().trim():"",m=g(r),b=(f||[]).filter(e=>!!e.preferred_cleaner_ids&&!!Array.isArray(e.preferred_cleaner_ids)&&0!==e.preferred_cleaner_ids.length&&e.preferred_cleaner_ids.some(e=>g(e)===m)),y=new Map;(d||[]).forEach(e=>{e.id&&y.set(e.id,e)}),b.forEach(e=>{e.id&&!y.has(e.id)&&y.set(e.id,e)});let v=Array.from(y.values()),h=new Date().toISOString().split("T")[0],w=new Date,k=new Date(w.getFullYear(),w.getMonth(),1).toISOString().split("T")[0],S=v.filter(e=>"completed"===e.status),C=v.filter(e=>["pending","confirmed","on_my_way","started"].includes(e.status)&&e.service_date>=h),E=v.filter(e=>e.service_date===h);v.filter(e=>"paid"===e.payment_status);let q=v.filter(e=>"completed"===e.status&&"paid"===e.payment_status&&e.service_date>=k),N=v.filter(e=>"completed"===e.status&&"paid"===e.payment_status),A=n(o.created_at),B=s(v),F=i(A,B),R=N.reduce((e,a)=>{let t=l({service_type:a.service_type||"",total_amount:Number(a.total_amount)||0,service_fee:Number(a.service_fee)||0,equipment_supply_price:Number(a.equipment_supply_price)||0,additional_cleaners_price:Number(a.additional_cleaners_price)||0,tip_amount:Number(a.tip_amount)||0,preferred_cleaner_ids:a.preferred_cleaner_ids,preferred_cleaner_id:a.preferred_cleaner_id},r,F);return e+t},0),I=q.reduce((e,a)=>{let t=l({service_type:a.service_type||"",total_amount:Number(a.total_amount)||0,service_fee:Number(a.service_fee)||0,equipment_supply_price:Number(a.equipment_supply_price)||0,additional_cleaners_price:Number(a.additional_cleaners_price)||0,tip_amount:Number(a.tip_amount)||0,preferred_cleaner_ids:a.preferred_cleaner_ids,preferred_cleaner_id:a.preferred_cleaner_id},r,F);return e+t},0),L=o.total_bookings?(o.completed_bookings||0)/o.total_bookings*100:0,D=o.completed_bookings?(o.on_time_bookings||0)/o.completed_bookings*100:0;return{success:!0,stats:{totalBookings:v.length,completedBookings:S.length,upcomingBookings:C.length,todayBookings:E.length,totalEarnings:R,monthlyEarnings:I,averageRating:Number(o.rating)||0,reliabilityScore:Number(o.reliability_score)||0,completionRate:L,onTimeRate:D}}}catch(e){return console.error("Error in getCleanerStats:",e),{success:!1,error:e instanceof Error?e.message:"Failed to fetch stats"}}}async function h(e,r){try{let t=await (0,a.createClient)(),n={updated_at:new Date().toISOString()};void 0!==r.isAvailable&&(n.is_available=r.isAvailable),void 0!==r.availableMonday&&(n.available_monday=r.availableMonday),void 0!==r.availableTuesday&&(n.available_tuesday=r.availableTuesday),void 0!==r.availableWednesday&&(n.available_wednesday=r.availableWednesday),void 0!==r.availableThursday&&(n.available_thursday=r.availableThursday),void 0!==r.availableFriday&&(n.available_friday=r.availableFriday),void 0!==r.availableSaturday&&(n.available_saturday=r.availableSaturday),void 0!==r.availableSunday&&(n.available_sunday=r.availableSunday);let{data:s,error:i}=await t.from("cleaners").update(n).eq("id",e).select().single();if(i)return console.error("Error updating cleaner availability:",i),{success:!1,error:i.message};return{success:!0,cleaner:s}}catch(e){return console.error("Error in updateCleanerAvailability:",e),{success:!1,error:e instanceof Error?e.message:"Failed to update availability"}}}(0,e.i(95975).ensureServerEntryExports)([d,u,_,f,p,g,m,b,y,v,h]),(0,r.registerServerReference)(d,"40a59651451de26f1e1318bdf061853f29caa0cb96",null),(0,r.registerServerReference)(u,"6043abd4f96c9644075ceca5fb9c27d4de151dc1de",null),(0,r.registerServerReference)(_,"0008ec0d16c34a0c3446af64c83f7600e71361b2d2",null),(0,r.registerServerReference)(f,"4010dfc5e7290ed566ac5451a825670e6b0a87a856",null),(0,r.registerServerReference)(p,"40644369c6d186ff3b456047295632caa4127d9b75",null),(0,r.registerServerReference)(g,"40b70fadc2d78351c0aaaa94538181d6f99823f978",null),(0,r.registerServerReference)(m,"6064d8a430608f311b64c7540b59c0c636ec49f7cc",null),(0,r.registerServerReference)(b,"70161269115dbe51e4a180874d06645c18c4fdb06f",null),(0,r.registerServerReference)(y,"40e353ec89965e9b4f7860098ee24cb05823cbac4e",null),(0,r.registerServerReference)(v,"0009e7b688087b33395d531c8fc22ba085a5ee9838",null),(0,r.registerServerReference)(h,"60590337447e35286ff3fd13afb4f2478fad04933e",null),e.s(["reportLateness",()=>b,"updateBookingStatus",()=>m],8214)}];

//# sourceMappingURL=app_cleaner_actions_ts_44101665._.js.map