module.exports=[19824,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),a=e.i(59756),i=e.i(61916),o=e.i(74677),s=e.i(69741),c=e.i(16795),l=e.i(87718),u=e.i(95169),d=e.i(47587),p=e.i(66012),g=e.i(70101),_=e.i(26937),f=e.i(10372),h=e.i(93695);e.i(52474);var m=e.i(5232),b=e.i(89171),v=e.i(26500);function y(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${n}`}var w=e.i(45015),R=e.i(95975);async function k(){try{let e=await (0,v.createClient)(),{data:t,error:r}=await e.from("pricing_rules").select("*").eq("is_active",!0).order("display_order",{ascending:!0});if(r)return console.error("Error fetching pricing rules:",r),[];return t||[]}catch(e){return console.error("Unexpected error fetching pricing rules:",e),[]}}async function E(e){let t=(await k()).find(t=>"base_price"===t.rule_type&&t.service_id===e);return t?.price||0}async function D(e){let t=(await k()).find(t=>"bedroom"===t.rule_type&&t.rule_value===e);return t?.price||0}async function S(e){let t=(await k()).find(t=>"bathroom"===t.rule_type&&t.rule_value===e);return t?.price||0}async function x(e){let t=(await k()).find(t=>"additional_service"===t.rule_type&&t.additional_service_id===e);return t?.price||0}async function C(){let e=(await k()).find(e=>"service_fee"===e.rule_type);return e?.percentage||0}async function q(e){let t=(await k()).find(t=>"frequency_discount"===t.rule_type&&t.rule_value===e);return t?.percentage||0}async function N(){let e=(await k()).find(e=>"fitted_room"===e.rule_type&&"per_room"===e.rule_key);return e?.price||0}async function A(){let e=(await k()).find(e=>"loose_carpet"===e.rule_type&&"per_carpet"===e.rule_key);return e?.price||0}function M(e){if(!e)return!1;let t=e.toLowerCase().trim();return!!(t.includes("standard")||t.includes("airbnb"))}async function P(e){let{serviceId:t,serviceName:r,bedrooms:n,bathrooms:a,additionalServiceIds:i,additionalServices:o=[],cleaningFrequency:s,discountAmount:c=0,numberOfFittedRooms:l="",numberOfLooseCarpets:u="",isCarpetCleaning:d=!1,cleaningEquipment:p="",numberOfCleaners:g=1}=e,_=await E(t),f=d?0:await D(n),h=d?0:await S(a),m=await N()*(parseFloat(l)||0),b=await A()*(parseFloat(u)||0),v=0;for(let e of i){let t=await x(e),r=o.find(t=>t.id===e);r?.requires_quantity,v+=t}let y=0;"yes"===p&&r&&M(r)&&(y=500);let w=0;r&&M(r)&&g>1&&(w=250*Math.max(0,Math.min(g-1,4)));let R=_+f+h+m+b+v+y+w,k=0,P=0;"one-time"!==s&&r&&""!==r.trim()&&M(r)&&(P=R*(k=await q(s))/100);let $=R-P,T=Math.max(0,$-c),O=$*await C()/100;return{basePrice:_,bedroomsPrice:f,bathroomsPrice:h,fittedRoomsPrice:m,looseCarpetsPrice:b,additionalServicesPrice:v,equipmentSupplyPrice:y,additionalCleanersPrice:w,subtotal:R,frequencyDiscountPercent:k,frequencyDiscountAmount:P,discountAmount:c,serviceFee:O,totalAmount:T+O}}async function $(e,t,r,n,a,i=0,o="",s="",c=!1,l,u,d=1){return P({serviceId:e,serviceName:l,bedrooms:t,bathrooms:r,additionalServiceIds:n,cleaningFrequency:a,discountAmount:i,numberOfFittedRooms:o,numberOfLooseCarpets:s,isCarpetCleaning:c,cleaningEquipment:u,numberOfCleaners:d})}async function T(e){try{let t=e.headers.get("x-api-key"),r=process.env.RECURRING_BOOKINGS_API_KEY;if(r&&t!==r)return b.NextResponse.json({error:"Unauthorized"},{status:401});let n=await (0,v.createClient)(),a=new Date;a.setHours(0,0,0,0);let i=y(a),{data:o,error:s}=await n.from("bookings").select("*").eq("is_recurring",!0).eq("recurrence_status","active").lte("next_booking_date",i).or(`recurrence_end_date.is.null,recurrence_end_date.gt.${i}`).is("parent_booking_id",null);if(s)return console.error("Error fetching recurring bookings:",s),b.NextResponse.json({error:"Failed to fetch recurring bookings",details:s.message},{status:500});if(!o||0===o.length)return b.NextResponse.json({success:!0,message:"No recurring bookings to create",created:0});let c=o.filter(e=>M(e.service_type)),l=o.filter(e=>!M(e.service_type));if(l.length>0&&console.warn(`Skipping ${l.length} recurring bookings for unsupported services:`,l.map(e=>({id:e.id,service_type:e.service_type}))),0===c.length)return b.NextResponse.json({success:!0,message:"No supported recurring bookings to create",created:0,skipped:l.length});let u=[],d=[];for(let e of c)try{let{data:t}=await n.from("bookings").select("service_date").or(`id.eq.${e.id},parent_booking_id.eq.${e.id}`).order("service_date",{ascending:!1}).limit(1).single();if(!t){d.push(`No last booking found for parent ${e.id}`);continue}t.service_date;let r=new Date(e.next_booking_date),a=function(e,t){let r=[],n=new Date(e),a=n.getMonth(),i=n.getFullYear(),o=new Date(i,a+1,0).getDate();switch(t){case"one-time":case"monthly":default:r.push(new Date(e));break;case"weekly":n.getDay();let s=new Date(i,a,n.getDate());for(;s.getMonth()===a&&s.getDate()<=o;)r.push(new Date(s)),s.setDate(s.getDate()+7);break;case"bi-weekly":let c=new Date(i,a,n.getDate());for(;c.getMonth()===a&&c.getDate()<=o;)r.push(new Date(c)),c.setDate(c.getDate()+14)}return r}(r,e.cleaning_frequency);if(0===a.length){d.push(`No dates calculated for booking ${e.id}`);continue}let i=await P({serviceId:e.service_id,serviceName:e.service_type,bedrooms:e.bedrooms,bathrooms:e.bathrooms,additionalServiceIds:e.additional_services||[],cleaningFrequency:e.cleaning_frequency,discountAmount:e.discount_amount||0,numberOfCleaners:e.number_of_cleaners||1}),o=[];for(let t=0;t<a.length;t++){let r=a[t],n=function(){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0"),a=Math.floor(1e6*Math.random()).toString().padStart(6,"0");return`SHL${t}${r}${n}${a}`}();o.push({booking_number:n,customer_first_name:e.customer_first_name,customer_last_name:e.customer_last_name,customer_email:e.customer_email,customer_phone:e.customer_phone,service_id:e.service_id,service_type:e.service_type,bedrooms:e.bedrooms,bathrooms:e.bathrooms,additional_services:e.additional_services,cleaning_equipment:e.cleaning_equipment,number_of_cleaners:e.number_of_cleaners||1,additional_cleaners_price:i.additionalCleanersPrice,preferred_cleaner_ids:e.preferred_cleaner_ids||null,preferred_cleaner_id:e.preferred_cleaner_id,cleaning_frequency:e.cleaning_frequency,service_date:y(r),service_time:e.service_time,service_duration:e.service_duration,service_address:e.service_address,service_apt_unit:e.service_apt_unit,service_suburb:e.service_suburb,service_city:e.service_city,special_instructions:e.special_instructions,tip_amount:e.tip_amount||0,base_price:i.basePrice,additional_services_price:i.additionalServicesPrice,equipment_supply_price:i.equipmentSupplyPrice,frequency_discount_percent:i.frequencyDiscountPercent,frequency_discount_amount:i.frequencyDiscountAmount,subtotal:i.subtotal,service_fee:i.serviceFee,total_amount:i.totalAmount,discount_code:e.discount_code,discount_amount:e.discount_amount||0,amount_paid:0,payment_status:"pending",status:"pending",user_id:e.user_id,parent_booking_id:0===t?e.id:null,is_recurring:!0,recurrence_status:"active",next_booking_date:null})}let{data:s,error:c}=await n.from("bookings").insert(o).select("id");if(c){d.push(`Failed to create bookings for parent ${e.id}: ${c.message}`);continue}if(!s||0===s.length){d.push(`No bookings created for parent ${e.id}`);continue}if(s.length>1){let e=s[0].id,t=s.slice(1).map(e=>e.id);await n.from("bookings").update({parent_booking_id:e}).in("id",t)}let l=a[a.length-1],p=function(e,t){let r=new Date(e);switch(t){case"one-time":default:r.setMonth(r.getMonth()+1);break;case"weekly":r.setMonth(r.getMonth()+1);let n=e.getDay();for(e.getDate(),r.setDate(1);r.getDay()!==n;)r.setDate(r.getDate()+1);break;case"bi-weekly":r.setMonth(r.getMonth()+1);let a=e.getDay();for(r.setDate(1);r.getDay()!==a;)r.setDate(r.getDate()+1);break;case"monthly":r.setMonth(r.getMonth()+1);let i=e.getDate(),o=new Date(r.getFullYear(),r.getMonth()+1,0).getDate();r.setDate(Math.min(i,o))}return r}(l,e.cleaning_frequency);await n.from("bookings").update({next_booking_date:y(p)}).eq("id",e.id),u.push(...s.map(e=>e.id))}catch(r){let t=r instanceof Error?r.message:"Unknown error";d.push(`Error processing booking ${e.id}: ${t}`),console.error(`Error creating recurring bookings for ${e.id}:`,r)}return b.NextResponse.json({success:!0,message:`Processed ${o.length} recurring booking series`,created:u.length,bookingIds:u,errors:d.length>0?d:void 0})}catch(e){return console.error("Error in create-recurring endpoint:",e),b.NextResponse.json({error:"Internal server error",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function O(e){return T(e)}(0,R.ensureServerEntryExports)([k,E,D,S,x,C,q,N,A]),(0,w.registerServerReference)(k,"00e68045b50ec07d1755fc7bc74581b353d37ec3d0",null),(0,w.registerServerReference)(E,"40b3e41c599ca115a2cca5d6967b86aeae096f5cce",null),(0,w.registerServerReference)(D,"407a0c9fe131443d583c59e091a1b9cdb277c64ba3",null),(0,w.registerServerReference)(S,"404fcf2f2031794cdecdea7fe841b00dcda4360c61",null),(0,w.registerServerReference)(x,"40ccca73e290a1009e293e3b28c989c1d66a8b3690",null),(0,w.registerServerReference)(C,"002ec01673d71389c24b8333c933b7d99e07a79364",null),(0,w.registerServerReference)(q,"40012760c2502a632427da471d267365b6bb590b70",null),(0,w.registerServerReference)(N,"00e8977a4d1164767b769a01a292ba7415706fb934",null),(0,w.registerServerReference)(A,"003e753166276d1e97b42fa21c960fab0a21ea9a7b",null),(0,R.ensureServerEntryExports)([P,$]),(0,w.registerServerReference)(P,"4080a015f076f9abd84630723e1126a06fc2a2f3de",null),(0,w.registerServerReference)($,"7f2bb1906fcfe166da78d502275e8b6157dcee9f53",null),e.s(["GET",()=>T,"POST",()=>O],91956);var I=e.i(91956);let U=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/bookings/create-recurring/route",pathname:"/api/bookings/create-recurring",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/bookings/create-recurring/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:H,workUnitAsyncStorage:F,serverHooks:j}=U;function K(){return(0,n.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:F})}async function L(e,t,n){U.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/bookings/create-recurring/route";b=b.replace(/\/index$/,"")||"/";let v=await U.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:y,params:w,nextConfig:R,parsedUrl:k,isDraftMode:E,prerenderManifest:D,routerServerContext:S,isOnDemandRevalidate:x,revalidateOnlyGenerated:C,resolvedPathname:q,clientReferenceManifest:N,serverActionsManifest:A}=v,M=(0,s.normalizeAppPath)(b),P=!!(D.dynamicRoutes[M]||D.routes[q]),$=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,k,!1):t.end("This page could not be found"),null);if(P&&!E){let e=!!D.routes[q],t=D.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await $();throw new h.NoFallbackError}}let T=null;!P||U.isDev||E||(T="/index"===(T=q)?"/":T);let O=!0===U.isDev||!P,I=P&&!O;A&&N&&(0,o.setManifestsSingleton)({page:b,clientReferenceManifest:N,serverActionsManifest:A});let H=e.method||"GET",F=(0,i.getTracer)(),j=F.getActiveScopeSpan(),K={params:w,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>U.onRequestError(e,t,n,a,S)},sharedContext:{buildId:y}},L=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),G=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let o=async e=>U.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${b}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),c=async a=>{var i,c;let l=async({previousCacheEntry:r})=>{try{if(!s&&x&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=K.renderOpts.fetchMetrics;let c=K.renderOpts.pendingWaitUntil;c&&n.waitUntil&&(n.waitUntil(c),c=void 0);let l=K.renderOpts.collectedTags;if(!P)return await (0,p.sendResponse)(L,B,i,K.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[f.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:x})},!1,S),t}},u=await U.handleResponse({req:e,nextConfig:R,cacheKey:T,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:C,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:s});if(!P)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&P||h.delete(f.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(L,B,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};j?await c(j):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${b}`,kind:i.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},c))}catch(t){if(t instanceof h.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:x})},!1,S),P)throw t;return await (0,p.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>K,"routeModule",()=>U,"serverHooks",()=>j,"workAsyncStorage",()=>H,"workUnitAsyncStorage",()=>F],19824)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_c353826d.js.map