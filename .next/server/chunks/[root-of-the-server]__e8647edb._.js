module.exports=[18622,(e,r,t)=>{r.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,r,t)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,r,t)=>{r.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},42315,(e,r,t)=>{"use strict";r.exports=e.r(18622)},47540,(e,r,t)=>{"use strict";r.exports=e.r(42315).vendored["react-rsc"].React},43590,e=>{"use strict";var r=e.i(47909),t=e.i(74017),a=e.i(96250),o=e.i(59756),s=e.i(61916),n=e.i(74677),i=e.i(69741),l=e.i(16795),d=e.i(87718),c=e.i(95169),u=e.i(47587),p=e.i(66012),f=e.i(70101),m=e.i(26937),g=e.i(10372),_=e.i(93695);e.i(52474);var h=e.i(5232),x=e.i(89171),w=e.i(26500);async function R(r){try{let t=await (0,w.createClient)(),{referralCode:a,referredEmail:o,bookingId:s}=await r.json();if(!a||!o)return x.NextResponse.json({error:"referralCode and referredEmail are required"},{status:400});let n=a.trim().toUpperCase(),i=o.trim().toLowerCase(),{data:l,error:d}=await t.from("profiles").select("email").eq("referral_code",n).maybeSingle();if(d)return console.error("Error finding referrer profile:",d),x.NextResponse.json({error:"Failed to find referrer profile",details:d.message},{status:500});if(!l||!l.email)return x.NextResponse.json({error:`Referrer not found for referral code: ${n}`},{status:404});let c=l.email.toLowerCase();if(c===i)return x.NextResponse.json({error:"Cannot process self-referral"},{status:400});let u=t.from("bookings").select("id, customer_email, referral_code, payment_status, total_amount, paystack_reference").eq("customer_email",i).eq("referral_code",n).eq("payment_status","paid");s&&(u=u.eq("id",s));let p=await u,f=p.data,m=p.error;if((!f||0===f.length)&&!m){let r=t.from("bookings").select("id, customer_email, referral_code, payment_status, total_amount, paystack_reference").eq("customer_email",i).eq("referral_code",n).eq("payment_status","pending").not("paystack_reference","is",null);s&&(r=r.eq("id",s));let{data:a,error:o}=await r;if(!o&&a&&a.length>0){let{verifyPayment:r}=await e.A(38665),o=[];for(let e of a)if(e.paystack_reference)try{let a=await r(e.paystack_reference);if(a.status&&"success"===a.data.status){let r=a.data.amount/100;await t.from("bookings").update({payment_status:"paid",paystack_transaction_id:a.data.id.toString(),amount_paid:r,status:"confirmed",updated_at:new Date().toISOString()}).eq("id",e.id),o.push({...e,payment_status:"paid"})}}catch(r){console.error(`Error verifying payment for booking ${e.id}:`,r)}o.length>0&&(f=o,m=null)}}let g=f,_=m;if(_)return console.error("Error finding bookings:",_),x.NextResponse.json({error:"Failed to find bookings",details:_.message},{status:500});if(!g||0===g.length)return x.NextResponse.json({error:"No paid bookings found with this referral code and email"},{status:404});let h=[];for(let e of g){let{data:r,error:a}=await t.from("referrals").select("id, status, referrer_reward_status").eq("referral_code",n).eq("referred_email",i).eq("referred_booking_id",e.id).maybeSingle();if(a){console.error("Error checking existing referral:",a),h.push({bookingId:e.id,success:!1,error:"Failed to check existing referral"});continue}if(!r){let{data:a,error:o}=await t.from("referrals").insert({referrer_email:c,referred_email:i,referral_code:n,status:"completed",referred_booking_id:e.id,referrer_reward_amount:150,referrer_reward_status:"pending"}).select("id, status, referrer_reward_status").single();if(o){console.error("Error creating referral record:",o),h.push({bookingId:e.id,success:!1,error:"Failed to create referral record"});continue}r=a}if("pending"===r.referrer_reward_status){let{data:a,error:o}=await t.from("profiles").select("id, credit_balance").eq("email",c).maybeSingle();if(o){console.error("Error fetching referrer profile:",o),h.push({bookingId:e.id,success:!1,error:"Failed to fetch referrer profile"});continue}if(!a){let{data:r,error:o}=await t.from("profiles").insert({email:c,credit_balance:0,first_name:"",last_name:""}).select("id, credit_balance").single();if(o||!r){console.error("Error creating referrer profile:",o),h.push({bookingId:e.id,success:!1,error:"Failed to create referrer profile"});continue}a=r}let s=a.credit_balance||0,l=s+150,{error:d}=await t.from("profiles").update({credit_balance:l,updated_at:new Date().toISOString()}).eq("id",a.id);if(d){console.error("Error updating referrer balance:",d),h.push({bookingId:e.id,success:!1,error:"Failed to update referrer balance"});continue}let{error:u}=await t.from("credit_transactions").insert({profile_id:a.id,email:c,transaction_type:"referral_reward",amount:150,balance_before:s,balance_after:l,description:`Referral reward for ${i}`,metadata:{referral_code:n,referred_email:i,booking_id:e.id,processed_retroactively:!0},payment_status:"completed"});if(u){console.error("Error creating credit transaction:",u),h.push({bookingId:e.id,success:!1,error:"Failed to create credit transaction"});continue}let{error:p}=await t.from("referrals").update({status:"completed",referrer_reward_status:"credited",updated_at:new Date().toISOString()}).eq("id",r.id);if(p){console.error("Error updating referral record:",p),h.push({bookingId:e.id,success:!1,error:"Failed to update referral record"});continue}h.push({bookingId:e.id,success:!0,referrerEmail:c,rewardAmount:150,balanceBefore:s,balanceAfter:l})}else h.push({bookingId:e.id,success:!1,error:"Reward already credited",referrer_reward_status:r.referrer_reward_status})}let R=h.every(e=>e.success),v=h.some(e=>e.success);return x.NextResponse.json({success:R,partialSuccess:v&&!R,results:h})}catch(e){return console.error("Error processing referral:",e),x.NextResponse.json({error:"Failed to process referral",message:e instanceof Error?e.message:"Unknown error"},{status:500})}}e.s(["POST",()=>R],85917);var v=e.i(85917);let y=new r.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/referrals/process/route",pathname:"/api/referrals/process",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/referrals/process/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:b,workUnitAsyncStorage:E,serverHooks:k}=y;function C(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:E})}async function q(e,r,a){y.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/referrals/process/route";x=x.replace(/\/index$/,"")||"/";let w=await y.prepare(e,r,{srcPage:x,multiZoneDraftMode:!1});if(!w)return r.statusCode=400,r.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:v,nextConfig:b,parsedUrl:E,isDraftMode:k,prerenderManifest:C,routerServerContext:q,isOnDemandRevalidate:N,revalidateOnlyGenerated:A,resolvedPathname:S,clientReferenceManifest:j,serverActionsManifest:I}=w,O=(0,i.normalizeAppPath)(x),P=!!(C.dynamicRoutes[O]||C.routes[S]),T=async()=>((null==q?void 0:q.render404)?await q.render404(e,r,E,!1):r.end("This page could not be found"),null);if(P&&!k){let e=!!C.routes[S],r=C.dynamicRoutes[O];if(r&&!1===r.fallback&&!e){if(b.experimental.adapterPath)return await T();throw new _.NoFallbackError}}let F=null;!P||y.isDev||k||(F="/index"===(F=S)?"/":F);let U=!0===y.isDev||!P,H=P&&!U;I&&j&&(0,n.setManifestsSingleton)({page:x,clientReferenceManifest:j,serverActionsManifest:I});let D=e.method||"GET",M=(0,s.getTracer)(),$=M.getActiveScopeSpan(),K={params:v,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:a.waitUntil,onClose:e=>{r.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(r,t,a,o)=>y.onRequestError(e,r,a,o,q)},sharedContext:{buildId:R}},L=new l.NodeNextRequest(e),B=new l.NodeNextResponse(r),G=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(r));try{let n=async e=>y.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let t=M.getRootSpanAttributes();if(!t)return;if(t.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${t.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=t.get("next.route");if(a){let r=`${D} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":r}),e.updateName(r)}else e.updateName(`${D} ${x}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var s,l;let d=async({previousCacheEntry:t})=>{try{if(!i&&N&&A&&!t)return r.statusCode=404,r.setHeader("x-nextjs-cache","REVALIDATED"),r.end("This page could not be found"),null;let s=await n(o);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=K.renderOpts.collectedTags;if(!P)return await (0,p.sendResponse)(L,B,s,K.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),r=(0,f.toNodeOutgoingHttpHeaders)(s.headers);d&&(r[g.NEXT_CACHE_TAGS_HEADER]=d),!r["content-type"]&&e.type&&(r["content-type"]=e.type);let t=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:r},cacheControl:{revalidate:t,expire:a}}}}catch(r){throw(null==t?void 0:t.isStale)&&await y.onRequestError(e,r,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,q),r}},c=await y.handleResponse({req:e,nextConfig:b,cacheKey:F,routeKind:t.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:A,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:i});if(!P)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||r.setHeader("x-nextjs-cache",N?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),k&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&P||_.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||r.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(L,B,new Response(c.value.body,{headers:_,status:c.value.status||200})),null};$?await l($):await M.withPropagatedContext(e.headers,()=>M.trace(c.BaseServerSpan.handleRequest,{spanName:`${D} ${x}`,kind:s.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},l))}catch(r){if(r instanceof _.NoFallbackError||await y.onRequestError(e,r,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,q),P)throw r;return await (0,p.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>C,"routeModule",()=>y,"serverHooks",()=>k,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>E],43590)},38665,e=>{e.v(r=>Promise.all(["server/chunks/[root-of-the-server]__752fe620._.js"].map(r=>e.l(r))).then(()=>r(42314)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__e8647edb._.js.map