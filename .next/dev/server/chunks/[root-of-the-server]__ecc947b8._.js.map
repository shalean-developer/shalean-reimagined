{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/27825/shalean-v2/shalean-reimagined/src/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from '@supabase/ssr'\r\nimport { cookies } from 'next/headers'\r\n\r\nexport async function createClient() {\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n  if (!supabaseUrl || !supabaseAnonKey) {\r\n    console.error('Missing Supabase environment variables: NEXT_PUBLIC_SUPABASE_URL or NEXT_PUBLIC_SUPABASE_ANON_KEY')\r\n    throw new Error('Supabase configuration is missing. Please check your environment variables.')\r\n  }\r\n\r\n  try {\r\n    const cookieStore = await cookies()\r\n\r\n    return createServerClient(\r\n      supabaseUrl,\r\n      supabaseAnonKey,\r\n      {\r\n        cookies: {\r\n          getAll() {\r\n            return cookieStore.getAll()\r\n          },\r\n          setAll(cookiesToSet) {\r\n            try {\r\n              cookiesToSet.forEach(({ name, value, options }) =>\r\n                cookieStore.set(name, value, options)\r\n              )\r\n            } catch {\r\n              // The `setAll` method was called from a Server Component.\r\n              // This can be ignored if you have middleware refreshing\r\n              // user sessions.\r\n            }\r\n          },\r\n        },\r\n      }\r\n    )\r\n  } catch (error) {\r\n    console.error('Error creating Supabase client:', error)\r\n    throw error\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM;IACN,MAAM;IAEN;;IAKA,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QAEjC,OAAO,IAAA,iMAAkB,EACvB,aACA,iBACA;YACE,SAAS;gBACP;oBACE,OAAO,YAAY,MAAM;gBAC3B;gBACA,QAAO,YAAY;oBACjB,IAAI;wBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAEjC,EAAE,OAAM;oBACN,0DAA0D;oBAC1D,wDAAwD;oBACxD,iBAAiB;oBACnB;gBACF;YACF;QACF;IAEJ,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,MAAM;IACR;AACF"}},
    {"offset": {"line": 87, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/27825/shalean-v2/shalean-reimagined/app/api/discount-codes/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { createClient } from '@/lib/supabase/server';\r\nimport { DiscountCode } from '@/types/booking';\r\n\r\n/**\r\n * GET /api/discount-codes\r\n * List all discount codes with optional pagination and filtering\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const searchParams = request.nextUrl.searchParams;\r\n    const page = parseInt(searchParams.get('page') || '1');\r\n    const limit = parseInt(searchParams.get('limit') || '50');\r\n    const isActive = searchParams.get('is_active');\r\n    const search = searchParams.get('search');\r\n\r\n    let query = supabase\r\n      .from('discount_codes')\r\n      .select('*', { count: 'exact' })\r\n      .order('created_at', { ascending: false });\r\n\r\n    // Filter by active status\r\n    if (isActive !== null) {\r\n      query = query.eq('is_active', isActive === 'true');\r\n    }\r\n\r\n    // Search by code\r\n    if (search) {\r\n      query = query.ilike('code', `%${search}%`);\r\n    }\r\n\r\n    // Pagination\r\n    const from = (page - 1) * limit;\r\n    const to = from + limit - 1;\r\n    query = query.range(from, to);\r\n\r\n    const { data, error, count } = await query;\r\n\r\n    if (error) {\r\n      console.error('Error fetching discount codes:', error);\r\n      return NextResponse.json(\r\n        { error: 'Failed to fetch discount codes', details: error.message },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({\r\n      data: data || [],\r\n      pagination: {\r\n        page,\r\n        limit,\r\n        total: count || 0,\r\n        totalPages: Math.ceil((count || 0) / limit),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error('Unexpected error fetching discount codes:', error);\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/discount-codes\r\n * Create a new discount code\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const supabase = await createClient();\r\n    const body = await request.json();\r\n\r\n    // Validate required fields\r\n    const {\r\n      code,\r\n      discount_type,\r\n      discount_value,\r\n      valid_from,\r\n      valid_until,\r\n      max_discount_amount,\r\n      min_purchase_amount,\r\n      max_uses,\r\n      is_active = true,\r\n    } = body;\r\n\r\n    // Validation\r\n    if (!code || typeof code !== 'string' || code.trim().length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Code is required and must be a non-empty string' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!discount_type || !['percentage', 'fixed'].includes(discount_type)) {\r\n      return NextResponse.json(\r\n        { error: 'discount_type must be either \"percentage\" or \"fixed\"' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (\r\n      typeof discount_value !== 'number' ||\r\n      discount_value <= 0 ||\r\n      (discount_type === 'percentage' && discount_value > 100)\r\n    ) {\r\n      return NextResponse.json(\r\n        {\r\n          error:\r\n            discount_type === 'percentage'\r\n              ? 'discount_value must be a number between 0 and 100'\r\n              : 'discount_value must be a positive number',\r\n        },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!valid_from || !valid_until) {\r\n      return NextResponse.json(\r\n        { error: 'valid_from and valid_until are required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate dates\r\n    const validFromDate = new Date(valid_from);\r\n    const validUntilDate = new Date(valid_until);\r\n    const now = new Date();\r\n\r\n    if (isNaN(validFromDate.getTime()) || isNaN(validUntilDate.getTime())) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid date format for valid_from or valid_until' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (validUntilDate <= validFromDate) {\r\n      return NextResponse.json(\r\n        { error: 'valid_until must be after valid_from' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate optional fields\r\n    if (\r\n      max_discount_amount !== null &&\r\n      max_discount_amount !== undefined &&\r\n      (typeof max_discount_amount !== 'number' || max_discount_amount <= 0)\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: 'max_discount_amount must be a positive number if provided' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (\r\n      min_purchase_amount !== null &&\r\n      min_purchase_amount !== undefined &&\r\n      (typeof min_purchase_amount !== 'number' || min_purchase_amount < 0)\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: 'min_purchase_amount must be a non-negative number if provided' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (\r\n      max_uses !== null &&\r\n      max_uses !== undefined &&\r\n      (typeof max_uses !== 'number' || max_uses <= 0 || !Number.isInteger(max_uses))\r\n    ) {\r\n      return NextResponse.json(\r\n        { error: 'max_uses must be a positive integer if provided' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Check if code already exists\r\n    const normalizedCode = code.trim().toUpperCase();\r\n    const { data: existingCode } = await supabase\r\n      .from('discount_codes')\r\n      .select('id')\r\n      .eq('code', normalizedCode)\r\n      .single();\r\n\r\n    if (existingCode) {\r\n      return NextResponse.json(\r\n        { error: 'A discount code with this code already exists' },\r\n        { status: 409 }\r\n      );\r\n    }\r\n\r\n    // Create the discount code\r\n    const discountCodeData = {\r\n      code: normalizedCode,\r\n      discount_type,\r\n      discount_value: Number(discount_value),\r\n      max_discount_amount:\r\n        max_discount_amount !== null && max_discount_amount !== undefined\r\n          ? Number(max_discount_amount)\r\n          : null,\r\n      min_purchase_amount:\r\n        min_purchase_amount !== null && min_purchase_amount !== undefined\r\n          ? Number(min_purchase_amount)\r\n          : null,\r\n      max_uses:\r\n        max_uses !== null && max_uses !== undefined ? Number(max_uses) : null,\r\n      valid_from: validFromDate.toISOString().split('T')[0], // Format as YYYY-MM-DD\r\n      valid_until: validUntilDate.toISOString().split('T')[0], // Format as YYYY-MM-DD\r\n      is_active: Boolean(is_active),\r\n      used_count: 0,\r\n    };\r\n\r\n    const { data: newDiscountCode, error: insertError } = await supabase\r\n      .from('discount_codes')\r\n      .insert(discountCodeData)\r\n      .select()\r\n      .single();\r\n\r\n    if (insertError) {\r\n      console.error('Error creating discount code:', insertError);\r\n      return NextResponse.json(\r\n        { error: 'Failed to create discount code', details: insertError.message },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { data: newDiscountCode, message: 'Discount code created successfully' },\r\n      { status: 201 }\r\n    );\r\n  } catch (error) {\r\n    console.error('Unexpected error creating discount code:', error);\r\n    if (error instanceof SyntaxError) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid JSON in request body' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}